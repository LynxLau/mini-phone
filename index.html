<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Mini Phone Â· Chat + Music</title>
  <!-- ä¾èµ–ï¼šTailwind / React 18 / Babel -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root { --accent:#7c5cff; }
    html,body{height:100%; background:#0a0a0a;}
    body{margin:0; display:grid; place-items:center; overflow:hidden;}
    .phone-wrap{height:100dvh; aspect-ratio:9/19.5; max-height:900px; max-width:min(480px, 100vw); padding:16px;}
    .panel { background: rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.08); }
    .btn { background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); }
    .btn:hover{ background: rgba(255,255,255,0.12); }
    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:20px; padding:8px 12px; border-radius:10px; background:#d33; color:#fff; font-size:12px;}
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="text/babel">
    const {useState,useEffect,useMemo} = React;

    /* -------- å°å·¥å…· -------- */
    const uid = () => Math.random().toString(36).slice(2,9);
    const loadJSON=(k,f)=>{try{const r=localStorage.getItem(k);return r?JSON.parse(r):f}catch{return f}};
    const saveJSON=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
    const toast=(m)=>{const el=document.createElement('div');el.className='toast';el.textContent=m;document.body.appendChild(el);setTimeout(()=>el.remove(),2200)};

    /* -------- App -------- */
    function App(){
      const [theme,setTheme]=useState(()=>loadJSON('mp_theme',{
        accent:'#7c5cff', bgType:'image', bgColor:'#0b0b0f', bgImage:'', blur:8, glass:true,
        font:'Inter, "Noto Sans SC", "PingFang SC", "Microsoft YaHei", system-ui, -apple-system, Segoe UI, Roboto'
      }));
      const [settings,setSettings]=useState(()=>loadJSON('mp_settings',{
        apiBase:'https://api.skyi.cc/v1', apiKey:'', model:'gemini 2.5 pro', systemPrompt:'',
        characterName:'', avatar:'', temperature:0.6
      }));
      const [characters,setCharacters]=useState(()=>loadJSON('mp_chars',[]));

      const [playlist,setPlaylist]=useState(()=>loadJSON('mp_playlist',[{id:uid(), title:'Sleepy Cat', url:''}]));
      const [currentId,setCurrentId]=useState(()=>loadJSON('mp_current', null));

      useEffect(()=>saveJSON('mp_theme',theme),[theme]);
      useEffect(()=>saveJSON('mp_settings',settings),[settings]);
      useEffect(()=>saveJSON('mp_playlist',playlist),[playlist]);
      useEffect(()=>saveJSON('mp_current',currentId),[currentId]);
      useEffect(()=>saveJSON('mp_chars',characters),[characters]);

      return (
        <div className="phone-wrap w-full">
          <div className="relative w-full h-full rounded-[32px] border border-white/15 shadow-2xl overflow-hidden bg-black/80 text-white"
               style={{fontFamily:theme.font, backgroundImage: theme.bgType==='image' && theme.bgImage ? `url(${theme.bgImage})` : 'none', backgroundSize:'cover', backgroundPosition:'center'}}>
            <div className="absolute inset-0" style={{backdropFilter:`blur(${theme.blur}px)`}}/>
            <div className="absolute left-1/2 -translate-x-1/2 top-2 w-40 h-4 rounded-full bg-black/60 border border-white/10" />
            <PhoneContent theme={theme} setTheme={setTheme} settings={settings} setSettings={setSettings}
              characters={characters} setCharacters={setCharacters}
              playlist={playlist} setPlaylist={setPlaylist} currentId={currentId} setCurrentId={setCurrentId}/>
          </div>
        </div>
      );
    }

    /* -------- å¤–å±‚å¸ƒå±€ -------- */
    function PhoneContent(props){
      const {theme,setTheme,settings,setSettings,characters,setCharacters,playlist,setPlaylist,currentId,setCurrentId} = props;
      const [screen,setScreen]=useState('home');

      return (
        <div className="absolute inset-0 flex flex-col">
          <div className="p-3 flex items-center justify-between">
            <div className="text-xs text-white/80">{new Date().toTimeString().slice(0,5)}</div>
            <div className="text-xs text-white/90 px-2 py-1 rounded-full border border-white/10 bg-black/40">
              API {settings.apiKey ? 'ON':'OFF'}
            </div>
          </div>

          <div className="flex-1 overflow-auto px-4 pb-4 space-y-3">
            {screen==='home' && <HomeGrid goto={setScreen} playlist={playlist} setPlaylist={setPlaylist} currentId={currentId} setCurrentId={setCurrentId}/>}
            {screen==='music' && <MusicPage back={()=>setScreen('home')} playlist={playlist} setPlaylist={setPlaylist} currentId={currentId} setCurrentId={setCurrentId}/>}
            {screen==='chat' && <ChatPage back={()=>setScreen('home')} settings={settings} characters={characters} setCharacters={setCharacters}/>}
            {screen==='settings' && <SettingsPage back={()=>setScreen('home')} theme={theme} setTheme={setTheme} settings={settings} setSettings={setSettings}/>}
            {screen==='diary' && <SimplePage title="æ—¥è®°" back={()=>setScreen('home')}/>}
            {screen==='weibo' && <SimplePage title="å¾®åš" back={()=>setScreen('home')}/>}
          </div>

          <div className="px-4 pb-5">
            <div className="panel rounded-2xl p-3 grid grid-cols-3 gap-2">
              <DockBtn label="éŸ³ä¹" onClick={()=>setScreen('music')}>ğŸµ</DockBtn>
              <DockBtn label="èŠå¤©" onClick={()=>setScreen('chat')}>ğŸ’¬</DockBtn>
              <DockBtn label="è®¾ç½®" onClick={()=>setScreen('settings')}>âš™ï¸</DockBtn>
            </div>
          </div>
        </div>
      );
    }
    const DockBtn=({children,label,onClick})=>(
      <button onClick={onClick} className="flex flex-col items-center gap-1">
        <div className="w-12 h-12 rounded-2xl panel grid place-items-center text-xl">{children}</div>
        <div className="text-xs opacity-90">{label}</div>
      </button>
    );

    /* -------- é¦–é¡µ + éŸ³ä¹ -------- */
    function HomeGrid({goto,playlist,setPlaylist,currentId,setCurrentId}){
      const current = React.useMemo(()=> playlist.find(x=>x.id===currentId) || playlist[0], [playlist,currentId]);
      React.useEffect(()=>{ if(!current && playlist.length) setCurrentId(playlist[0].id); },[current,playlist,setCurrentId]);
      return (
        <div className="space-y-3">
          <div className="panel rounded-2xl p-4">
            <div className="flex items-start gap-3">
              <div className="w-16 h-16 rounded-2xl bg-black/50 border border-white/10 grid place-items-center">
                <div className="w-12 h-12 rounded-full bg-gradient-to-br from-black/40 to-black/80 grid place-items-center">
                  <div className="w-2 h-2 bg-white/80 rounded-full"></div>
                </div>
              </div>
              <div className="flex-1">
                <div className="text-base font-medium">Sleepy Cat</div>
                <div className="text-xs opacity-80">anemoia / crossing you</div>
                <div className="mt-2 flex gap-2">
                  <button onClick={()=>goto('music')} className="px-3 py-1.5 rounded bg-[var(--accent)] text-white text-xs">æ‰“å¼€æ’­æ”¾å™¨</button>
                  <button className="px-3 py-1.5 rounded bg-white/10 border border-white/10 text-xs">å½“å‰</button>
                </div>
              </div>
            </div>
          </div>
          <div className="grid grid-cols-2 gap-3">
            <div className="panel rounded-2xl h-28" />
            <div className="panel rounded-2xl h-28" />
          </div>
          <div className="grid grid-cols-3 gap-6 pt-2">
            <IconBtn label="éŸ³ä¹" onClick={()=>goto('music')}>ğŸµ</IconBtn>
            <IconBtn label="èŠå¤©" onClick={()=>goto('chat')}>ğŸ’¬</IconBtn>
            <IconBtn label="è®¾ç½®" onClick={()=>goto('settings')}>âš™ï¸</IconBtn>
            <IconBtn label="ç›¸å†Œ" onClick={()=>toast('æš‚æœªå¼€æ”¾')}>ğŸ–¼ï¸</IconBtn>
            <IconBtn label="æ—¥è®°" onClick={()=>goto('diary')}>ğŸ“</IconBtn>
            <IconBtn label="å¾®åš" onClick={()=>goto('weibo')}>ğŸ”—</IconBtn>
          </div>
        </div>
      );
    }
    const IconBtn=({children,label,onClick})=>(
      <button onClick={onClick} className="flex flex-col items-center gap-2">
        <div className="w-16 h-16 rounded-2xl panel grid place-items-center text-2xl">{children}</div>
        <div className="text-xs opacity-90">{label}</div>
      </button>
    );

    function MusicPage({playlist,setPlaylist,currentId,setCurrentId,back}){
      const current = React.useMemo(()=> playlist.find(x=>x.id===currentId) || playlist[0], [playlist,currentId]);
      const [title,setTitle]=useState(''); const [url,setUrl]=useState('');
      React.useEffect(()=>{ if(!current && playlist.length) setCurrentId(playlist[0].id); },[current,playlist,setCurrentId]);
      return (
        <div className="space-y-3">
          <Header title="éŸ³ä¹" back={back}/>
          <div className="panel rounded-2xl p-4 space-y-3">
            <div className="text-sm">å½“å‰ï¼š{current? (current.title || 'æœªå‘½åæ›²ç›®'):'æš‚æ— '}</div>
            <audio controls src={current?.url || undefined} className="w-full"/>
            <div className="flex gap-2">
              <input className="flex-1 bg-white/10 border border-white/10 rounded px-2 py-1 text-sm" placeholder="æ›²å" value={title} onChange={e=>setTitle(e.target.value)}/>
              <input className="flex-[2] bg-white/10 border border-white/10 rounded px-2 py-1 text-sm" placeholder="éŸ³é¢‘ URL" value={url} onChange={e=>setUrl(e.target.value)}/>
              <button className="px-3 py-1 rounded bg-[var(--accent)] text-white text-sm"
                onClick={()=>{
                  if(!url) return;
                  const t={id:uid(), title:title || (url.split('/').pop()??'æœªå‘½åæ›²ç›®'), url};
                  setPlaylist([...playlist,t]); setTitle(''); setUrl(''); if(!currentId) setCurrentId(t.id);
                }}>æ·»åŠ </button>
            </div>
            <div className="max-h-44 overflow-auto space-y-2">
              {playlist.map(t=>(
                <div key={t.id} className={`flex items-center gap-2 text-sm bg-white/5 border border-white/10 rounded p-2 ${currentId===t.id?'ring-1 ring-[var(--accent)]/70':''}`}>
                  <button onClick={()=>setCurrentId(t.id)} className="text-xs px-2 py-1 rounded bgç™½/10">æ’­æ”¾</button>
                  <div className="flex-1 truncate">{t.title||'æœªå‘½åæ›²ç›®'}</div>
                  <button onClick={()=>setPlaylist(playlist.filter(x=>x.id!==t.id))} className="opacity-80 hover:opacity-100 text-xs">åˆ é™¤</button>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    /* -------- Header/Settings -------- */
    const SimplePage=({title,back})=>(
      <div className="space-y-3">
        <Header title={title} back={back}/>
        <div className="panel rounded-2xl p-6 text-sm">è¿™é‡Œå…ˆå ä½ã€‚</div>
      </div>
    );

    function SettingsPage({theme,setTheme,settings,setSettings,back}){
      return (
        <div className="space-y-3">
          <Header title="è®¾ç½®" back={back}/>
          <SettingsPanel theme={theme} setTheme={setTheme} settings={settings} setSettings={setSettings}/>
        </div>
      );
    }

    const Header=({title,back})=>(
      <div className="flex items-center justify-between">
        <button onClick={back} className="px-3 py-1.5 text-xs rounded bg-white/10 border border-white/10">è¿”å›</button>
        <div className="px-4 py-1.5 rounded-2xl bg-black/50 border border-white/10">{title}</div>
        <div className="w-[62px]"/>
      </div>
    );

    function SettingsPanel({settings,setSettings,theme,setTheme}){
      const [tab,setTab]=useState('api');
      const defaults={apiBase:'https://api.skyi.cc/v1',apiKey:'',model:'gemini 2.5 pro',systemPrompt:'',characterName:'',avatar:'',temperature:0.6};
      const [temp,setTemp]=useState(()=>({...defaults,...settings}));
      const [tTheme,setTTheme]=useState(theme);
      const [models,setModels]=useState([]); const [checking,setChecking]=useState(false); const [checkMsg,setCheckMsg]=useState('');
      const tval = Number.isFinite(+temp.temperature)?+temp.temperature:0.6;

      const baseUrl = React.useMemo(()=> (temp.apiBase||'').replace(/\/$/,''), [temp.apiBase]);
      const headers = React.useMemo(()=> ({'Content-Type':'application/json','Authorization':'Bearer '+(temp.apiKey||'')}), [temp.apiKey]);

      async function fetchModels(){
        setChecking(true); setCheckMsg(''); setModels([]);
        try{
          const res = await fetch(baseUrl + '/models', {headers});
          if(!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          const list = (data?.data || data?.models || []).map(x=>x.id || x.name).filter(Boolean).sort();
          setModels(list);
          setCheckMsg(`å·²è¿æ¥ Â· ${list.length} ä¸ªæ¨¡å‹ âœ…`);
        }catch(e){ setCheckMsg('è¿æ¥å¤±è´¥ Â· ' + (e.message||e)); toast(e.message||e); }
        finally{ setChecking(false); }
      }

      async function testAPI(){
        setChecking(true); setCheckMsg('');
        try{
          const res = await fetch(baseUrl + '/models', {headers});
          if(!res.ok) throw new Error('HTTP '+res.status);
          await res.json();
          setCheckMsg('æµ‹è¯•é€šè¿‡ Â· API å¯ç”¨ âœ…');
        }catch(e){ setCheckMsg('æµ‹è¯•å¤±è´¥ Â· ' + (e.message||e)); toast(e.message||e); }
        finally{ setChecking(false); }
      }

      return (
        <div className="grid grid-cols-1 gap-3 text-sm">
          <div className="flex gap-1">
            <TabButton active={tab==='api'} onClick={()=>setTab('api')}>API</TabButton>
            <TabButton active={tab==='beauty'} onClick={()=>setTab('beauty')}>ç¾åŒ–</TabButton>
            <TabButton active={tab==='font'} onClick={()=>setTab('font')}>å­—ä½“</TabButton>
            <TabButton active={tab==='background'} onClick={()=>setTab('background')}>æ‰‹æœºèƒŒæ™¯</TabButton>
          </div>

          {tab==='api' && (
            <div className="rounded-xl border border-white/10 p-3 bg-white/5 space-y-3">
              <Row label="è§’è‰²å"><input value={temp.characterName} onChange={e=>setTemp({...temp,characterName:e.target.value})} className="flex-1 bg-white/10 rounded px-2 py-1 border borderç™½/10"/></Row>
              <Row label="å¤´åƒURL"><input value={temp.avatar} onChange={e=>setTemp({...temp,avatar:e.target.value})} className="flex-1 bgç™½/10 rounded px-2 py-1 border borderç™½/10" placeholder="http(s)://..."/></Row>
              <Row label="API Base"><input value={temp.apiBase} onChange={e=>setTemp({...temp,apiBase:e.target.value})} className="flex-1 bgç™½/10 rounded px-2 py-1 border borderç™½/10" placeholder="https://ä½ çš„ç½‘å…³/v1"/></Row>
              <Row label="API Key"><input type="password" value={temp.apiKey} onChange={e=>setTemp({...temp,apiKey:e.target.value})} className="flex-1 bgç™½/10 rounded px-2 py-1 border borderç™½/10" placeholder="sk-..."/></Row>
              <Row label="æ¨¡å‹">
                <input value={temp.model} onChange={e=>setTemp({...temp,model:e.target.value})} className="flex-1 bgç™½/10 rounded px-2 py-1 border borderç™½/10" placeholder="é€‰æ‹©æˆ–æ‰‹å¡«"/>
                {models.length>0 && (
                  <select className="text-xs bgç™½/10 px-2 py-1 rounded border borderç™½/10"
                          value={temp.model || models[0]}
                          onChange={e=>setTemp({...temp,model:e.target.value})}>
                    {models.map(m => <option key={m} value={m}>{m}</option>)}
                  </select>
                )}
              </Row>

              <div className="flex items-center gap-2">
                <label className="text-xs opacity-90">Temperature</label>
                <input type="range" min="0" max="2" step="0.1" value={tval} onChange={e=>setTemp({...temp,temperature:+e.target.value})}/>
                <span className="text-xs opacity-90 w-10">{tval.toFixed(1)}</span>
              </div>

              <label className="text-xs opacity-90">System Prompt</label>
              <textarea value={temp.systemPrompt} onChange={e=>setTemp({...temp,systemPrompt:e.target.value})} className="bgç™½/10 rounded-lg px-3 py-2 border borderç™½/10 min-h-[88px]"></textarea>

              <div className="mt-2 p-2 rounded-lg bgç™½/5 border borderç™½/10 space-y-2">
                <div className="flex flex-wrap items-center gap-2">
                  <button onClick={fetchModels} disabled={checking || !temp.apiKey || !temp.apiBase}
                          className="text-xs px-3 py-1 rounded btn disabled:opacity-50">{checking ? 'è·å–ä¸­â€¦' : 'è·å–æ¨¡å‹åˆ—è¡¨'}</button>
                  <button onClick={testAPI} disabled={checking || !temp.apiKey || !temp.apiBase}
                          className="text-xs px-3 py-1 rounded btn disabled:opacity-50">{checking ? 'æµ‹è¯•ä¸­â€¦' : 'æµ‹è¯• API'}</button>
                </div>
                <div className="text-xs opacity-90">{checkMsg || 'å…¼å®¹ OpenAI /v1ï¼›è‹¥ 404 ä¼šè‡ªåŠ¨å°è¯•æ—§ /v1/completionsã€‚'}</div>
              </div>

              <div className="flex items-center justify-end gap-2 mt-2">
                <button onClick={()=>{ setSettings({...temp,temperature:tval}); setTheme(tTheme); toast('å·²ä¿å­˜'); }} className="text-xs px-3 py-1 rounded bg-[var(--accent)] text-white">ä¿å­˜</button>
              </div>
            </div>
          )}

          {tab==='beauty' && (
            <div className="rounded-xl border borderç™½/10 p-3 bgç™½/5 space-y-3">
              <Row label="ä¸»é¢˜è‰²"><input type="color" value={tTheme.accent} onChange={e=>setTheme({...tTheme,accent:e.target.value})} className="w-8 h-8 rounded"/></Row>
              <Row label="æ¨¡ç³Š"><input type="range" min="0" max="20" value={tTheme.blur} onChange={e=>setTheme({...tTheme,blur:+e.target.value})}/> <span className="text-xs opacity-90 w-8 text-right">{tTheme.blur}</span></Row>
            </div>
          )}

          {tab==='font' && (
            <div className="rounded-xl border borderç™½/10 p-3 bgç™½/5 space-y-3">
              <Row label="å­—ä½“æ ˆ"><input value={tTheme.font} onChange={e=>setTheme({...tTheme,font:e.target.value})} className="flex-1 bgç™½/10 rounded px-2 py-1 border borderç™½/10" placeholder='è‡ªå®šä¹‰ï¼Œå¦‚ "Inter, Noto Sans SC, PingFang SC, Microsoft YaHei"'/></Row>
              <div className="text-xs opacity-80">å¿«é€Ÿé€‰æ‹©</div>
              <div className="grid grid-cols-1 gap-2">
                {[
                  ['ç®€é»‘é€šç”¨','Inter, "Noto Sans SC", "PingFang SC", "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif'],
                  ['å®‹ä½“ä¹¦é¢','"Noto Serif SC", "Songti SC", "SimSun", "STSong", serif'],
                  ['åœ†è§’æ–°æ´¾','"Smiley Sans", "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif'],
                  ['æ–‡æ¥·é£','"LXGW WenKai", "Kaiti SC", "STKaiti", "Noto Serif SC", serif'],
                  ['ç­‰å®½æ··æ’','"JetBrains Mono", Consolas, Menlo, "Noto Sans SC", "PingFang SC", monospace']
                ].map(([name,stack])=>(
                  <button key={name} onClick={()=>setTheme({...tTheme,font:stack})}
                          className="btn px-3 py-2 rounded text-left">
                    <div className="text-xs opacity-70">{name}</div>
                    <div className="text-sm" style={{fontFamily:stack}}>{stack}</div>
                  </button>
                ))}
              </div>
            </div>
          )}

          {tab==='background' && (
            <div className="rounded-xl border borderç™½/10 p-3 bgç™½/5 space-y-3">
              <Row label="ç±»å‹">
                <select value={tTheme.bgType} onChange={e=>setTheme({...tTheme,bgType:e.target.value})} className="text-xs bgç™½/10 px-2 py-1 rounded border borderç™½/10">
                  <option value="color">çº¯è‰²èƒŒæ™¯</option>
                  <option value="image">å›¾ç‰‡èƒŒæ™¯</option>
                </select>
              </Row>
              {theme.bgType==='color' ? (
                <Row label="é¢œè‰²"><input type="color" value={theme.bgColor} onChange={e=>setTheme({...theme,bgColor:e.target.value})} className="w-8 h-8 rounded"/></Row>
              ) : (
                <Row label="å›¾ç‰‡">
                  <label className="text-xs btn px-2 py-1 rounded cursor-pointer">ä¸Šä¼ å›¾ç‰‡
                    <input type="file" accept="image/*" className="hidden" onChange={e=>{
                      const f=e.target.files&&e.target.files[0]; if(!f) return;
                      const r=new FileReader(); r.onload=()=>setTheme({...theme,bgImage:r.result}); r.readAsDataURL(f);
                    }}/>
                  </label>
                  {theme.bgImage && <button onClick={()=>setTheme({...theme,bgImage:''})} className="ml-2 text-xs px-2 py-1 rounded btn">æ¸…é™¤</button>}
                </Row>
              )}
              <div className="text-xs opacity-80">æç¤ºï¼šæ­¤èƒŒæ™¯ä»…ä½œç”¨äºæ‰‹æœºå±å¹•å†…éƒ¨ã€‚</div>
            </div>
          )}
        </div>
      );
    }

    const Row=({label,children})=>(<div className="flex items-center gap-3"><div className="w-20 shrink-0 text-xs opacity-90">{label}</div><div className="flex-1 flex items-center flex-wrap gap-2">{children}</div></div>);
    const TabButton=({active,onClick,children})=>(<button onClick={onClick} className={`px-3 py-1.5 rounded-lg border text-xs ${active?'bg-white/15 border-white/20':'bg-white/5 border-white/10 hover:bg-white/10'}`}>{children}</button>);

    /* ===========================================================
       èŠå¤©é¡µï¼ˆè¾“å…¥æ¡†é’‰åº• + è®¾ç½®æŠ½å±‰ï¼šæœ¬åœ°å¯¼å…¥ã€ä¸»é¢˜ç¾åŒ–å¯å†™è„šæœ¬ã€Userè®¾å®šï¼‰
       ä¸¥ç¦ OOCï¼šå¼ºåˆ¶å…ˆè¯»è§’è‰²å¡ä¸ä¸–ç•Œä¹¦
       =========================================================== */
    function ChatPage({settings,characters,setCharacters,back}){
      const [selectedId,setSelectedId]=useState(null);
      const selected = React.useMemo(()=>characters.find(c=>c.id===selectedId)||null,[characters,selectedId]);

      // æ¶ˆæ¯
      const [msgs,setMsgs]=useState([]);

      // å³ä¾§æŠ½å±‰
      const [drawerOpen,setDrawerOpen]=useState(false);

      // è§’è‰²é¡µå†…ç¾åŒ–/è„šæœ¬/Userè®¾å®šï¼ˆæ¯è§’è‰²ç‹¬ç«‹å­˜å‚¨ï¼‰
      const [uiUserBubble,setUiUserBubble]=useState('#7c5cff');
      const [uiBotBubble,setUiBotBubble]=useState('rgba(255,255,255,0.08)');
      const [uiTextColor,setUiTextColor]=useState('#ffffff');
      const [uiFont,setUiFont]=useState('');
      const [enableStatus,setEnableStatus]=useState(false);
      const [statusCode,setStatusCode]=useState(
`function renderStatus(ctx){
  const {roleName, time} = ctx;
  return { html: 'ğŸŸ£ ' + roleName + ' <span style="opacity:.8;margin-left:8px">' + time + '</span>' };
}`);

      const [userRoleNote,setUserRoleNote]=useState('');
      const [jsonText,setJsonText]=useState('');
      const [jsonPreview,setJsonPreview]=useState('');

      // æ¢å¤/ä¿å­˜
      useEffect(()=>{
        if(!selected) return;
        const saved = loadJSON('mp_role_'+selected.id, null);
        if(saved){
          setUiUserBubble(saved.uiUserBubble||'#7c5cff');
          setUiBotBubble(saved.uiBotBubble||'rgba(255,255,255,0.08)');
          setUiTextColor(saved.uiTextColor||'#ffffff');
          setUiFont(saved.uiFont||'');
          setEnableStatus(!!saved.enableStatus);
          setStatusCode(saved.statusCode || statusCode);
          setUserRoleNote(saved.userRoleNote || '');
          setJsonText(''); setJsonPreview('');
        }else{
          setUiUserBubble(getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#7c5cff');
          setUiBotBubble('rgba(255,255,255,0.08)');
          setUiTextColor('#ffffff');
          setUiFont('');
          setEnableStatus(false);
          setJsonText(''); setJsonPreview('');
        }
        setMsgs([]);
      },[selectedId]);

      useEffect(()=>{
        if(!selected) return;
        saveJSON('mp_role_'+selected.id,{
          uiUserBubble, uiBotBubble, uiTextColor, uiFont,
          enableStatus, statusCode, userRoleNote,
          // roleData ä¿ç•™ï¼ˆå¦‚æœæœ‰ï¼‰
          ...(() => {
            const s = loadJSON('mp_role_'+selected.id, {});
            return s.roleData ? {roleData: s.roleData} : {};
          })()
        });
      },[selected, uiUserBubble, uiBotBubble, uiTextColor, uiFont, enableStatus, statusCode, userRoleNote]);

      // API
      const base = (settings.apiBase||'').replace(/\/$/,'');
      const headers = {'Content-Type':'application/json','Authorization':'Bearer '+(settings.apiKey||'')};

      async function send(text){
        const modelToUse = (selected?.model || settings.model || '').trim();
        if(!settings.apiKey || !settings.apiBase || !modelToUse){
          toast('API è°ƒç”¨å¤±è´¥ï¼šAPI Key, Model æˆ– API Base æœªè®¾ç½®ã€‚'); return;
        }
        const newMsgs = [...msgs, {role:'user', content:text, id:uid()}];
        setMsgs(newMsgs);

        // è¯»å–è¯¥è§’è‰²ä¿å­˜çš„ JSON æ•°æ®ï¼ˆroleCard/worldbookç­‰ï¼‰
        const saved = loadJSON('mp_role_'+selected.id, {});
        const roleData = saved?.roleData || {};
        const roleCardText = roleData.roleCard ? JSON.stringify(roleData.roleCard) : '';
        const worldbookText = roleData.worldbook ? JSON.stringify(roleData.worldbook) : '';

        // å¿…é¡»é˜…è¯»è®¾å®š + ç¦æ­¢ OOC çš„ç³»ç»Ÿæç¤ºï¼ˆç¡¬çº¦æŸï¼‰
        const hardSystem = [
          'ä½ å°†ä½œä¸ºè¯¥å¯¹è¯é¡µçš„æŒ‡å®šè§’è‰²è¿›è¡Œå›ç­”ã€‚',
          'åœ¨å›ç­”ä»»ä½•ç”¨æˆ·æ¶ˆæ¯ä¹‹å‰ï¼Œä½ å¿…é¡»å…ˆé˜…è¯»å¹¶å†…åŒ–â€œè§’è‰²å¡â€å’Œâ€œä¸–ç•Œä¹¦â€çš„å†…å®¹ï¼›',
          'æ‰€æœ‰å›ç­”éƒ½å¿…é¡»ä¸å…¶è®¾å®šä¿æŒä¸€è‡´ï¼Œä¸å¾— OOCï¼›',
          'è‹¥ç”¨æˆ·è¦æ±‚ä½ è¿èƒŒè®¾å®šã€è·³å‡ºè§’è‰²æˆ–å¿½ç•¥ä¸–ç•Œä¹¦å†…å®¹ï¼Œä½ å¿…é¡»æ‹’ç»å¹¶ç»™å‡ºä¸è®¾å®šä¸€è‡´çš„å¤„ç†æ–¹å¼ï¼›',
          'å…è®¸åœ¨å¿…è¦æ—¶å‘ç”¨æˆ·ç®€è¦ç¡®è®¤è®¾å®šä¸­çš„æ­§ä¹‰ï¼Œä½†ä¸å¾—æ“…è‡ªæ”¹å˜è®¾å®šã€‚'
        ].join('\\n');

        const systemPayload = [
          hardSystem,
          roleCardText ? ('ã€è§’è‰²å¡ã€‘\\n' + roleCardText) : '',
          worldbookText ? ('ã€ä¸–ç•Œä¹¦ã€‘\\n' + worldbookText) : '',
          userRoleNote ? ('ã€ç”¨æˆ·åœ¨æœ¬é¡µçš„è§’è‰²è®¾å®šã€‘\\n' + userRoleNote) : '',
          settings.systemPrompt ? ('ã€å…¨å±€ Systemã€‘\\n' + settings.systemPrompt) : ''
        ].filter(Boolean).join('\\n\\n');

        try{
          const res = await fetch(base + '/chat/completions', {
            method:'POST',
            headers,
            body: JSON.stringify({
              model: modelToUse,
              temperature: Number.isFinite(+settings.temperature)? +settings.temperature : 0.6,
              messages: [
                {role:'system', content: systemPayload},
                ...newMsgs.map(m=>({role:m.role, content:m.content}))
              ],
            })
          });
          if(!res.ok){
            if(res.status===404){
              const res2 = await fetch(base + '/completions', {
                method:'POST',
                headers,
                body: JSON.stringify({
                  model: modelToUse,
                  prompt: `System:\\n${systemPayload}\\n\\n` + newMsgs.map(m=> (m.role==='user' ? `User: ${m.content}` : `Assistant: ${m.content}`)).join('\\n') + '\\nAssistant:',
                  temperature: Number.isFinite(+settings.temperature)? +settings.temperature : 0.6
                })
              });
              if(!res2.ok) throw new Error('HTTP ' + res2.status);
              const data2 = await res2.json();
              const text2 = data2?.choices?.[0]?.text ?? '[empty]';
              setMsgs(m=>[...m,{role:'assistant', content:text2, id:uid()}]);
              return;
            }
            throw new Error('HTTP ' + res.status);
          }
          const data = await res.json();
          const content = data?.choices?.[0]?.message?.content ?? '[empty]';
          setMsgs(m=>[...m,{role:'assistant', content, id:uid()}]);
        }catch(e){
          toast('è¯·æ±‚å¤±è´¥ï¼š' + (e.message||e));
        }
      }

      // çŠ¶æ€æ æ¸²æŸ“ï¼ˆè„šæœ¬ä»…å½±å“ UIï¼‰
      const statusEl = useMemo(()=>{
        if(!enableStatus || !selected) return null;
        try{
          const f = new Function(statusCode + '; return typeof renderStatus==="function" ? renderStatus : null;');
          const fn = f();
          const result = fn ? fn({ roleName: selected.name || 'æœªå‘½å', time: new Date().toLocaleTimeString() }) : '';
          return (
            <div className="h-6 text-[11px] px-2 border-b border-white/10 bg-black/40"
                 dangerouslySetInnerHTML={ typeof result==='object' && result && 'html' in result
                   ? {__html: result.html} : {__html: String(result ?? '')} } />
          );
        }catch(err){
          return <div className="h-6 text-[11px] px-2 border-b border-red-500/30 bg-red-900/20">è„šæœ¬é”™è¯¯ï¼š{String(err.message||err)}</div>;
        }
      },[enableStatus,statusCode,selected]);

      return (
        <div className="space-y-3">
          <Header title="èŠå¤©" back={back}/>

          {!selected && (
            <div className="panel rounded-2xl p-4 space-y-3">
              <div className="flex items-center justify-between">
                <div className="text-sm opacity-90">æˆ‘çš„è§’è‰²ï¼ˆ{characters.length}ï¼‰</div>
                <button className="btn px-3 py-1.5 rounded" onClick={()=>{
                  const name=prompt('è§’è‰²æ˜µç§°'); if(!name) return;
                  const c={id:uid(), name, model:settings.model||'', createdAt:Date.now()};
                  setCharacters([...characters,c]); setSelectedId(c.id);
                }}>ï¼‹ åˆ›å»ºè§’è‰²</button>
              </div>
              <div className="space-y-2">
                {characters.length===0 && <div className="text-sm opacity-80">è¿˜æ²¡æœ‰è§’è‰²ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªå§ã€‚</div>}
                {characters.map(c=>(
                  <div key={c.id} className="flex items-center justify-between bg-white/5 border border-white/10 rounded p-2">
                    <div className="text-sm">
                      <div className="font-medium">{c.name}</div>
                      <div className="text-xs opacity-80">æ¨¡å‹ï¼š{c.model || 'æœªé€‰æ‹©'}</div>
                    </div>
                    <div className="flex gap-2">
                      <button className="btn px-2 py-1 rounded text-xs" onClick={()=>setSelectedId(c.id)}>è¿›å…¥</button>
                      <button className="btn px-2 py-1 rounded text-xs" onClick={()=>setCharacters(characters.filter(x=>x.id!==c.id))}>åˆ é™¤</button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {selected && (
            <div className="panel rounded-2xl border border-white/10 overflow-hidden">
              {/* é¡¶éƒ¨æ¡ */}
              <div className="flex items-center justify-between px-4 py-2 border-b border-white/10 bg-black/30">
                <div className="text-sm"><span className="opacity-70">å½“å‰ï¼š</span>{selected.name}</div>
                <div className="flex items-center gap-2">
                  <button className="btn px-3 py-1.5 rounded text-xs" onClick={()=>setDrawerOpen(true)}>è®¾ç½®</button>
                  <button className="btn px-3 py-1.5 rounded text-xs" onClick={()=>setSelectedId(null)}>è¿”å›åˆ—è¡¨</button>
                </div>
              </div>

              {/* è‡ªå®šä¹‰è„šæœ¬çŠ¶æ€æ  */}
              {statusEl}

              {/* ä¸»ä½“ï¼šæ¶ˆæ¯æ»šåŠ¨ + è¾“å…¥æ ç²˜åº• */}
              <div className="h-[60vh] flex flex-col">
                <div className="flex-1 min-h-0 overflow-auto px-3 py-3 space-y-2"
                     style={{color:uiTextColor, fontFamily: uiFont || undefined}}>
                  {msgs.length===0 && <div className="text-xs opacity-70">å¼€å§‹èŠå¤©å§ã€‚ä½ å¯ä»¥å…ˆè¯´â€œä½ å¥½â€ã€‚</div>}
                  {msgs.map(m=>(
                    <div key={m.id}
                         className={`max-w-[85%] px-3 py-2 rounded-2xl text-sm leading-relaxed border ${m.role==='user'
                          ? 'self-end ml-auto text-white'
                          : 'self-start mr-auto text-white/90'}`}
                         style={{
                           background: m.role==='user' ? uiUserBubble : uiBotBubble,
                           borderColor: m.role==='user' ? 'rgba(124,92,255,.6)' : 'rgba(255,255,255,.18)'
                         }}>
                      {m.content}
                    </div>
                  ))}
                </div>

                <div className="sticky bottom-0 border-t border-white/10 bg-black/60 backdrop-blur px-3 py-2">
                  <ChatInput onSend={(t)=>{ if(!t.trim()) return; send(t.trim()); }}/>
                </div>
              </div>
            </div>
          )}

          {/* å³ä¾§æŠ½å±‰ï¼šæœ¬åœ°å¯¼å…¥ + ä¸»é¢˜ç¾åŒ–ï¼ˆå¯å†™è„šæœ¬ï¼‰+ Userè®¾å®š */}
          {selected && drawerOpen && (
            <div className="fixed inset-0 z-50">
              <div className="absolute inset-0 bg-black/50" onClick={()=>setDrawerOpen(false)} />
              <div className="absolute right-0 top-0 h-full w-[88%] max-w-sm bg-black/90 border-l border-white/10 p-3 overflow-auto">
                <div className="flex items-center justify-between mb-2">
                  <div className="text-sm font-medium">è®¾ç½®ï¼ˆ{selected.name}ï¼‰</div>
                  <button className="btn px-2 py-1 rounded text-xs" onClick={()=>setDrawerOpen(false)}>å…³é—­</button>
                </div>

                {/* â‘  å¯¼å…¥ä¸–ç•Œä¹¦ / è§’è‰²å¡ï¼ˆJSONï¼‰ */}
                <div className="rounded-lg border border-white/10 p-3 bg-white/5 space-y-2">
                  <div className="text-sm font-medium">â‘  å¯¼å…¥ä¸–ç•Œä¹¦ / è§’è‰²å¡ï¼ˆJSONï¼‰</div>

                  <!-- æœ¬åœ°æ–‡ä»¶å¯¼å…¥ -->
                  <label className="text-xs btn px-2 py-1 rounded cursor-pointer inline-flex items-center gap-2">
                    é€‰æ‹©æœ¬åœ°æ–‡ä»¶
                    <input type="file" accept=".json,application/json" className="hidden"
                      onChange={async e=>{
                        const f=e.target.files&&e.target.files[0]; if(!f) return;
                        const t=await f.text();
                        setJsonText(t);
                        try{ const obj=JSON.parse(t||'{}'); setJsonPreview(JSON.stringify(obj,null,2)); }
                        catch(err){ setJsonPreview('JSON è§£æå¤±è´¥ï¼š'+err.message); }
                      }}/>
                  </label>

                  <textarea className="w-full h-28 bg-black/60 border border-white/10 rounded p-2 text-xs font-mono"
                            placeholder='ç²˜è´´æˆ–ç¼–è¾‘ JSONï¼Œå¦‚ {"roleName":"Gavriel","worldbook":{...}}'
                            value={jsonText} onChange={e=>setJsonText(e.target.value)} />
                  <div className="flex gap-2">
                    <button className="btn px-3 py-1 rounded text-xs" onClick={()=>{
                      try{ const obj = JSON.parse(jsonText||'{}'); setJsonPreview(JSON.stringify(obj,null,2)); }
                      catch(err){ setJsonPreview('JSON è§£æå¤±è´¥ï¼š'+err.message); }
                    }}>é¢„è§ˆè§£æ</button>
                    <button className="px-3 py-1 rounded bg-[var(--accent)] text-white text-xs" onClick={()=>{
                      try{
                        const obj = JSON.parse(jsonText||'{}');
                        if(obj.style){
                          if(obj.style.userBubble) setUiUserBubble(obj.style.userBubble);
                          if(obj.style.botBubble)  setUiBotBubble(obj.style.botBubble);
                          if(obj.style.textColor)  setUiTextColor(obj.style.textColor);
                          if(obj.style.fontFamily) setUiFont(obj.style.fontFamily);
                        }
                        if(obj.scripts && obj.scripts.status){ setStatusCode(obj.scripts.status); setEnableStatus(true); }
                        if(obj.userRoleNote){ setUserRoleNote(obj.userRoleNote); }
                        // ä¿å­˜æ•´ä»½åˆ°æœ¬è§’è‰²ï¼Œä¾›å‘é€æ—¶å¼ºåˆ¶è¯»å–
                        const saved = loadJSON('mp_role_'+selected.id, {});
                        saveJSON('mp_role_'+selected.id, {...saved, roleData: obj});
                        setJsonPreview('å·²åº”ç”¨å¹¶ä¿å­˜åˆ°æœ¬è§’è‰²');
                      }catch(err){ setJsonPreview('åº”ç”¨å¤±è´¥ï¼š'+err.message); }
                    }}>åº”ç”¨</button>
                  </div>
                  <pre className="text-xs font-mono whitespace-pre-wrap bg-black/40 border border-white/10 rounded p-2">{jsonPreview}</pre>
                </div>

                {/* â‘¡ ä¸»é¢˜ç¾åŒ–ï¼ˆå¯å†™è„šæœ¬ï¼‰ */}
                <div className="rounded-lg border border-white/10 p-3 bg-white/5 space-y-3 mt-3">
                  <div className="text-sm font-medium">â‘¡ ä¸»é¢˜ç¾åŒ–ï¼ˆå¯å†™è„šæœ¬ï¼‰</div>
                  <div className="flex items-center gap-3 text-xs">
                    <span className="w-20 opacity-80">ç”¨æˆ·æ°”æ³¡</span>
                    <input type="color" value={uiUserBubble} onChange={e=>setUiUserBubble(e.target.value)} />
                  </div>
                  <div className="flex items-center gap-3 text-xs">
                    <span className="w-20 opacity-80">è§’è‰²æ°”æ³¡</span>
                    <input type="color" value={colorToHex(uiBotBubble)} onChange={e=>setUiBotBubble(e.target.value)} />
                  </div>
                  <div className="flex items-center gap-3 text-xs">
                    <span className="w-20 opacity-80">æ–‡å­—é¢œè‰²</span>
                    <input type="color" value={uiTextColor} onChange={e=>setUiTextColor(e.target.value)} />
                  </div>
                  <div className="flex items-center gap-3 text-xs">
                    <span className="w-20 opacity-80">å­—ä½“æ ˆ</span>
                    <input className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10"
                           placeholder='Inter, Noto Sans SC, PingFang SC, Microsoft YaHei'
                           value={uiFont} onChange={e=>setUiFont(e.target.value)} />
                  </div>

                  <label className="flex items-center gap-2 text-xs mt-2">
                    <input type="checkbox" checked={enableStatus} onChange={e=>setEnableStatus(e.target.checked)} />
                    å¯ç”¨è‡ªå®šä¹‰ UI è„šæœ¬
                  </label>
                  <textarea className="w-full h-28 bg-black/60 border border-white/10 rounded p-2 text-xs font-mono"
                            placeholder={`// è¿”å›å­—ç¬¦ä¸²æˆ– {html: '<b>..</b>'}\nfunction renderStatus(ctx){\n  const {roleName, time} = ctx;\n  return { html: 'ğŸŸ£ ' + roleName + ' <span style=\\'opacity:.8;margin-left:8px\\'>' + time + '</span>' };\n}`}
                            value={statusCode} onChange={e=>setStatusCode(e.target.value)} />
                  <div className="text-[11px] opacity-80">æç¤ºï¼šè„šæœ¬åªå½±å“æœ¬é¡µ UIï¼ˆå¦‚çŠ¶æ€æ æ–‡å­—ï¼‰ï¼Œä¸å‚ä¸æ¨¡å‹æ¨ç†ã€‚</div>
                </div>

                {/* â‘¢ User çš„æœ¬é¡µè§’è‰²è®¾å®š */}
                <div className="rounded-lg border border-white/10 p-3 bg-white/5 space-y-2 mt-3">
                  <div className="text-sm font-medium">â‘¢ User çš„æœ¬é¡µè§’è‰²è®¾å®š</div>
                  <textarea className="w-full h-24 bg-black/60 border border-white/10 rounded p-2 text-sm"
                            placeholder="å†™æ¸…ä½ åœ¨æ­¤é¡µçš„èº«ä»½ã€è¯­æ°”ã€è¾¹ç•Œç­‰"
                            value={userRoleNote} onChange={e=>setUserRoleNote(e.target.value)} />
                  <div className="flex justify-end">
                    <button className="px-3 py-1 rounded bg-[var(--accent)] text-white text-xs" onClick={()=>toast('å·²ä¿å­˜')}>
                      ä¿å­˜
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function colorToHex(c){
      const ctx = document.createElement('canvas').getContext('2d');
      ctx.fillStyle = c; const computed = ctx.fillStyle;
      if(computed.startsWith('#')) return computed;
      const m = computed.match(/rgba?\((\d+), ?(\d+), ?(\d+)/i);
      if(!m) return '#ffffff';
      const to = n=> (+n).toString(16).padStart(2,'0');
      return `#${to(m[1])}${to(m[2])}${to(m[3])}`;
    }

    /* -------- è¾“å…¥æ¡†ç»„ä»¶ï¼ˆå›è½¦å‘é€ï¼Œç²˜åº•å®¹å™¨é‡Œï¼‰ -------- */
    const ChatInput=({onSend})=>{
      const [v,setV]=useState('');
      return (
        <div className="flex items-center gap-2">
          <input className="flex-1 bg-white/10 rounded-xl px-3 py-2 text-sm border border-white/10 focus:outline-none"
                 placeholder="è¯´ç‚¹ä»€ä¹ˆâ€¦"
                 value={v} onChange={e=>setV(e.target.value)}
                 onKeyDown={e=>{ if(e.key==='Enter' && !e.shiftKey){ onSend(v); setV(''); }}}/>
          <button className="px-3 py-2 rounded-xl bg-[var(--accent)] text-white text-sm" onClick={()=>{onSend(v); setV('')}}>
            å‘é€
          </button>
        </div>
      );
    };

    /* -------- æ¸²æŸ“ -------- */
    ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
  </script>
</body>
</html>
