<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Mini Phone â€” Goth</title>

  <!-- ä¾èµ–ï¼šä¸»æº jsDelivrï¼Œ3.5s å›é€€ unpkgï¼Œ7s å›é€€ cdnjs -->
  <script>window.__depsLoaded=false;</script>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js" onload="window.__depsLoaded=true"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <script>
    (function fallback(){
      function ok(){return window.React&&window.ReactDOM&&window.Babel}
      function add(src){var s=document.createElement('script');s.src=src;s.async=false;document.head.appendChild(s)}
      setTimeout(function(){ if(!ok()){ add('https://unpkg.com/react@18/umd/react.production.min.js'); add('https://unpkg.com/react-dom@18/umd/react-dom.production.min.js'); add('https://unpkg.com/@babel/standalone/babel.min.js'); }}, 3500);
      setTimeout(function(){ if(!ok()){ add('https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js'); add('https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js'); add('https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js'); }}, 7000);
    })();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{ --accent:#8e86ff; --glass:rgba(255,255,255,0.06); }
    html,body,#root{height:100%}
    body{background:#000;color:#fff;margin:0}
    /* iOS çœŸå…¨å± */
    .vh{ min-height:100dvh; }
    .safe-y{ padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom); }
    /* é”™è¯¯æç¤ºï¼Œä¸å†â€œçº¯é»‘â€ */
    #errbox{position:fixed;z-index:9999;left:50%;top:20px;transform:translateX(-50%);background:#b91c1c;color:#fff;
      border:1px solid #fecaca;border-radius:10px;padding:10px 12px;max-width:92%;font:12px/1.4 ui-sans-serif,system-ui}
    #errbox b{font-weight:600}
    #loader{position:fixed;inset:0;display:grid;place-items:center;color:#9ca3af;font:14px ui-sans-serif,system-ui}
  </style>
</head>
<body>
  <noscript style="color:#fff;padding:12px">éœ€è¦å¯ç”¨ JavaScriptã€‚</noscript>
  <div id="root"></div>
  <div id="loader">æ­£åœ¨åŠ è½½èµ„æºâ€¦</div>
  <div id="errbox" style="display:none"></div>

  <script>
    // æ•è·æ‰€æœ‰å¼‚å¸¸ï¼Œç»™å‡ºå¯è§æç¤º
    function showError(msg){
      var box=document.getElementById('errbox');
      box.innerHTML='<b>é¡µé¢æŠ¥é”™ï¼š</b> '+String(msg || 'æœªçŸ¥é”™è¯¯');
      box.style.display='block';
      setTimeout(function(){ box.style.display='none' }, 6000);
      console.error('[MiniPhone]', msg);
    }
    window.addEventListener('error', function(e){ showError(e.message) });
    window.addEventListener('unhandledrejection', function(e){ showError((e.reason&&e.reason.message)||e.reason||'Promise é”™è¯¯') });
  </script>

  <!-- Appï¼ˆBabel ç¼–è¯‘ï¼‰ -->
  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    // ------------ small utils ------------
    const uid = () => Math.random().toString(36).slice(2,9);
    const userMsg = (text) => ({ id: uid(), role: 'user', text });
    const botMsg  = (text) => ({ id: uid(), role: 'assistant', text });
    const fmtTime = (d)=> String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
    const fileToDataURL = (file)=> new Promise((res,rej)=>{ if(!file) return res(''); const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });

    function bgStyle(theme){
      if(theme.bgType==='color') return {background:theme.bgColor};
      return { filter:'grayscale(1)', backgroundImage:`url(${theme.bgImage})`, backgroundSize:'cover', backgroundPosition:'center center' };
    }

    function useLocalStorage(key, initial){
      const [state,setState] = React.useState(()=>{ try{ const raw=localStorage.getItem(key); return raw?JSON.parse(raw):initial } catch { return initial } });
      React.useEffect(()=>{ try{ localStorage.setItem(key, JSON.stringify(state)) } catch {} }, [key,state]);
      return [state,setState];
    }

    // ------------ app ------------
    function App(){ return <MiniPhone/> }

    function MiniPhone(){
      const [theme, setTheme] = useLocalStorage('mp_theme', {
        accent:'#8e86ff', bgType:'image', bgColor:'#0a0a0d', bgImage:'', blur:8, glass:true,
        font:'Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto'
      });
      const [playlist, setPlaylist] = useLocalStorage('mp_playlist', [{ title:'Sleepy Cat', url:'', id:uid() }]);
      const [currentId, setCurrentId] = useLocalStorage('mp_current', null);

      const defaults = { apiBase:'https://api.openai.com', apiKey:'', model:'', systemPrompt:'', characterName:'Valuri', avatar:'', temperature:0.6 };
      const [settings, setSettings] = useLocalStorage('mp_settings', defaults);
      useEffect(()=>{ setSettings(prev=>({ ...defaults, ...prev })) },[]);

      const [aiMode, setAiMode] = useLocalStorage('mp_aiMode', true);
      const [messages, setMessages] = useLocalStorage('mp_msgs', [botMsg('æˆ‘åœ¨ã€‚æŠŠè€³æœºæˆ´ä¸Š, è¾¹å¬è¾¹è¯´ã€‚')]);
      const [input, setInput] = useState('');
      const [view, setView] = useState('home'); // home | chat | player | settings

      useEffect(()=>{ const r=document.documentElement.style; r.setProperty('--accent', theme.accent); r.setProperty('--glass', theme.glass?'rgba(255,255,255,0.06)':'rgba(255,255,255,0)') },[theme]);
      useEffect(()=>{ if(!currentId && playlist[0]) setCurrentId(playlist[0].id) },[currentId,playlist,setCurrentId]);

      const apiOn = Boolean(settings.apiKey && settings.model);

      return (
        <div className="vh w-full relative" style={{...bgStyle(theme), fontFamily: theme.font}}>
          <div className="absolute inset-0" style={{backdropFilter:`blur(${theme.blur}px)`}}/>
          <div className="relative z-10 mx-auto p-0 safe-y">
            {/* é¡¶æ éšè—ï¼ˆç•™ç»“æ„æ›´ç¨³ï¼‰ */}
            <div style={{display:'none'}}><TopBar onSettings={()=>setView('settings')} apiOn={apiOn}/></div>

            <div className="flex justify-center items-start vh">
              <DeviceFrame>
                <ScreenChrome apiOn={apiOn}/>
                {view==='home' && <HomeScreen
                  playlist={playlist} setPlaylist={setPlaylist}
                  currentId={currentId} setCurrentId={setCurrentId}
                  onOpenPlayer={()=>setView('player')}
                  onOpenChat={()=>setView('chat')}
                  onOpenSettings={()=>setView('settings')}
                />}
                {view==='chat' && <Overlay title={settings.characterName||'èŠå¤©'} onBack={()=>setView('home')}>
                  <ChatCard messages={messages} setMessages={setMessages}
                    input={input} setInput={setInput} aiMode={aiMode} setAiMode={setAiMode} settings={settings}/>
                </Overlay>}
                {view==='player' && <Overlay title="æ’­æ”¾å™¨" onBack={()=>setView('home')}>
                  <PlayerCard playlist={playlist} setPlaylist={setPlaylist} currentId={currentId} setCurrentId={setCurrentId}/>
                </Overlay>}
                {view==='settings' && <Overlay title="è®¾ç½®" onBack={()=>setView('home')}>
                  <SettingsPanel settings={settings} setSettings={setSettings} theme={theme} setTheme={setTheme}/>
                </Overlay>}
              </DeviceFrame>
            </div>
          </div>
        </div>
      );
    }

    function TopBar({onSettings,apiOn}){
      return (
        <div className="rounded-2xl p-4 shadow-xl border border-white/10" style={{background:'var(--glass)'}}>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <span className="text-sm px-2 py-1 rounded-full border border-white/10 bg-white/5">Mini Phone</span>
              <span className="text-xs opacity-70">Chat + Music</span>
            </div>
            <div className="flex items-center gap-3">
              <span className={`text-[11px] px-2 py-0.5 rounded-full ${apiOn?'bg-green-500/20 text-green-300':'bg-white/10 text-white/70'}`}>{apiOn?'API ON':'API OFF'}</span>
              <button onClick={onSettings} className="text-xs px-2 py-1 rounded bg-white/10 border border-white/10 hover:bg-white/15">è®¾ç½®</button>
            </div>
          </div>
        </div>
      )
    }

    function DeviceFrame({children}){
      return (
        <div className="relative w-[392px] md:w-[420px]">
          <div className="relative p-2 rounded-[44px] bg-gradient-to-b from-white/10 to-white/5 border border-white/10 shadow-[0_30px_120px_rgba(0,0,0,0.7)]">
            <div className="absolute -left-1 top-24 h-16 w-[3px] rounded-full bg-white/15"></div>
            <div className="absolute -left-1 top-44 h-10 w-[3px] rounded-full bg-white/15"></div>
            <div className="absolute -right-1 top-36 h-24 w-[3px] rounded-full bg-white/15"></div>
            <div className="relative rounded-[36px] overflow-hidden ring-1 ring-white/10 bg-black/80 h-[780px] md:h-[844px]">
              <div className="pointer-events-none absolute inset-0" style="background-image:radial-gradient(rgba(255,255,255,0.04) 1px, transparent 1px);background-size:3px 3px;opacity:.35"></div>
              <div className="pointer-events-none absolute inset-0" style="background:radial-gradient(120% 120% at 50% 10%, transparent 30%, rgba(0,0,0,0.55) 85%)"></div>
              <div className="absolute left-1/2 -translate-x-1/2 top-0 h-7 w-40 bg-black rounded-b-2xl shadow-[0_6px_12px_rgba(0,0,0,0.6)]"></div>
              <div className="absolute left-[calc(50%-56px)] top-2 w-2.5 h-2.5 rounded-full bg-zinc-700"></div>
              <div className="absolute left-1/2 -translate-x-1/2 top-2 w-16 h-1.5 rounded bg-zinc-700"></div>

              {children}

              <div className="absolute left-1/2 -translate-x-1/2 bottom-2 w-24 h-1.5 rounded-full bg-white/40"></div>
            </div>
          </div>
        </div>
      )
    }

    function ScreenChrome({apiOn}){
      const [clock,setClock]=useState(()=>fmtTime(new Date()));
      useEffect(()=>{const t=setInterval(()=>setClock(fmtTime(new Date())),1000);return()=>clearInterval(t)},[]);
      return (
        <div className="flex items-center justify-between px-4 pt-8 pb-2 text-xs text-white/80 select-none">
          <span>{clock}</span>
          <span className={`px-2 py-0.5 rounded-full ${apiOn?'bg-green-500/20 text-green-300':'bg-white/10'}`}>{apiOn?'API ON':'API OFF'}</span>
        </div>
      )
    }

    function HomeScreen({playlist,setPlaylist,currentId,setCurrentId,onOpenPlayer,onOpenChat,onOpenSettings}){
      const current = useMemo(()=>playlist.find(x=>x.id===currentId) || playlist[0],[playlist,currentId]);
      return (
        <div className="px-4 pb-6 flex flex-col gap-3">
          <div className="rounded-3xl p-4 bg-white/5 border border-white/10 backdrop-blur shadow-xl">
            <div className="flex items-center gap-4">
              <VinylDisc spinning/>
              <div className="min-w-0 flex-1">
                <div className="text-sm font-medium truncate">{current?.title||'æœªå‘½åæ›²ç›®'}</div>
                <div className="text-[11px] opacity-70 truncate">anemoia / crossing you</div>
                <div className="mt-3 flex items-center gap-2">
                  <button className="text-xs px-3 py-1 rounded bg-[var(--accent)] text-white" onClick={onOpenPlayer}>æ‰“å¼€æ’­æ”¾å™¨</button>
                  <button className="text-xs px-3 py-1 rounded bg-white/10 border border-white/10" onClick={()=>setCurrentId(current?.id||null)}>å½“å‰</button>
                </div>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-3">
            <GlassCard className="h-28"/><GlassCard className="h-28"/>
          </div>

          <div className="grid grid-cols-3 gap-3 py-1">
            {[
              {k:'music',label:'éŸ³ä¹',on:onOpenPlayer,emoji:'ğŸµ'},
              {k:'chat',label:'èŠå¤©',on:onOpenChat,emoji:'ğŸ’¬'},
              {k:'set',label:'è®¾ç½®',on:onOpenSettings,emoji:'âš™ï¸'},
              {k:'photo',label:'ç›¸å†Œ',on:()=>{},emoji:'ğŸ–¼ï¸'},
              {k:'note',label:'å°è®°',on:()=>{},emoji:'ğŸ“'},
              {k:'link',label:'é“¾æ¥',on:()=>{},emoji:'ğŸ”—'},
            ].map(it=>(<AppIcon key={it.k} label={it.label} onClick={it.on}>{it.emoji}</AppIcon>))}
          </div>

          <div className="mt-1 px-3 py-2 rounded-3xl bg-white/10 border border-white/10 backdrop-blur flex items-center justify-around">
            <DockIcon label="éŸ³ä¹" onClick={onOpenPlayer}><span className="text-xl">ğŸµ</span></DockIcon>
            <DockIcon label="èŠå¤©" onClick={onOpenChat}><span className="text-xl">ğŸ’¬</span></DockIcon>
            <DockIcon label="è®¾ç½®" onClick={onOpenSettings}><span className="text-xl">âš™ï¸</span></DockIcon>
          </div>
        </div>
      )
    }

    const GlassCard=({className=''})=><div className={`rounded-3xl bg-white/5 border border-white/10 ${className}`}></div>;
    function VinylDisc({spinning}){
      return (
        <div className="relative w-28 h-28">
          <div className="absolute inset-0 rounded-2xl bg-[radial-gradient(circle_at_30%_30%,rgba(255,255,255,0.08),transparent)] border border-white/10"></div>
          <div className={`absolute right-[-14px] top-1/2 -translate-y-1/2 w-24 h-24 rounded-full grid place-items-center ${spinning?'animate-spin':''}`} style={{animationDuration:'6s',background:'radial-gradient(circle,#0c0c0f 25%,#15151a 26%,#0c0c0f 40%,#15151a 60%,#0c0c0f 75%)'}}>
            <div className="w-3 h-3 rounded-full bg-white/80"></div>
          </div>
        </div>
      )
    }
    function AppIcon({children,label,onClick}){
      return (
        <button onClick={onClick} className="group flex flex-col items-center gap-1">
          <div className="w-16 h-16 rounded-2xl bg-white/10 border border-white/10 grid place-items-center group-active:scale-95 transition-transform">
            <span className="text-xl">{children}</span>
          </div>
          <div className="text-[11px] opacity-75">{label}</div>
        </button>
      )
    }
    function DockIcon({children,label,onClick}){
      return (
        <button onClick={onClick} className="group flex flex-col items-center gap-1 px-3 py-1">
          <div className="w-12 h-12 rounded-2xl bg-white/10 border border-white/10 grid place-items-center group-active:scale-95 transition-transform">{children}</div>
          <div className="text-[11px] opacity-75">{label}</div>
        </button>
      )
    }

    // è¦†ç›–å±‚ï¼šå¤´éƒ¨å›ºå®šã€å†…å®¹æ»šåŠ¨ï¼Œé“ºæ»¡â€œæ‰‹æœºå±å¹•â€
    function Overlay({title,children,onBack}){
      return (
        <div className="absolute inset-0 bg-black/60 backdrop-blur-sm">
          <div className="h-full flex flex-col">
            <div className="h-10 px-4 flex items-center justify-between">
              <button onClick={onBack} className="text-xs px-2 py-1 rounded bg-white/10 border border-white/10">è¿”å›</button>
              <div className="text-sm opacity-90">{title}</div>
              <div className="w-10"></div>
            </div>
            <div className="flex-1 p-3 overflow-auto" style={{WebkitOverflowScrolling:'touch'}}>
              <div className="rounded-2xl border border-white/10 bg-[#0b0b0f]/85 p-3 min-h-full">
                {children}
              </div>
            </div>
          </div>
        </div>
      )
    }

    function PlayerCard({playlist,setPlaylist,currentId,setCurrentId}){
      const current = useMemo(()=>playlist.find(x=>x.id===currentId)||playlist[0],[playlist,currentId]);
      useEffect(()=>{ if(!current && playlist.length) setCurrentId(playlist[0].id) },[current,playlist,setCurrentId]);
      return (
        <div className="flex flex-col gap-3">
          <div className="text-sm font-medium">æ’­æ”¾å™¨</div>
          {current?(
            <div className="flex flex-col gap-2">
              <div className="text-xs opacity-80 truncate">å½“å‰: {current.title||'æœªå‘½åæ›²ç›®'}</div>
              <audio controls src={current.url||undefined} className="w-full"></audio>
            </div>
          ):(<div className="text-xs opacity-70">æš‚æ— æ›²ç›®</div>)}
          <PlaylistEditor playlist={playlist} setPlaylist={setPlaylist} currentId={currentId} setCurrentId={setCurrentId}/>
        </div>
      )
    }
    function PlaylistEditor({playlist,setPlaylist,currentId,setCurrentId}){
      const [title,setTitle]=useState(''); const [url,setUrl]=useState('');
      return (
        <div className="flex flex-col gap-2">
          <div className="flex gap-2">
            <input value={title} onChange={e=>setTitle(e.target.value)} placeholder="æ›²å" className="flex-1 text-sm bg-white/10 rounded px-2 py-1 border border-white/10 focus:outline-none"/>
            <input value={url} onChange={e=>setUrl(e.target.value)} placeholder="éŸ³é¢‘ URL" className="flex-[2] text-sm bg-white/10 rounded px-2 py-1 border border-white/10 focus:outline-none"/>
            <button onClick={()=>{ if(!url)return; const track={title:title||(url.split('/').pop()??'æœªå‘½åæ›²ç›®'),url,id:uid()}; setPlaylist([...playlist,track]); setTitle(''); setUrl(''); if(!currentId) setCurrentId(track.id); }} className="text-sm px-3 py-1 rounded bg-[var(--accent)]/90 hover:bg-[var(--accent)] text-white">æ·»åŠ </button>
          </div>
          <div className="max-h-40 overflow-auto flex flex-col gap-1">
            {playlist.map(track=>(
              <div key={track.id} className={`group flex items-center gap-2 text-sm bg-white/5 border border-white/10 rounded p-2 ${currentId===track.id?'ring-1 ring-[var(--accent)]/70':''}`}>
                <button onClick={()=>setCurrentId(track.id)} className="text-xs px-2 py-1 rounded bg-white/10 hover:bg-white/15">æ’­æ”¾</button>
                <div className="flex-1 truncate">{track.title||'æœªå‘½åæ›²ç›®'}</div>
                <button onClick={()=>setPlaylist(playlist.filter(x=>x.id!==track.id))} className="opacity-60 hover:opacity-100 text-xs">åˆ é™¤</button>
              </div>
            ))}
          </div>
        </div>
      )
    }

    function ChatCard({messages,setMessages,input,setInput,aiMode,setAiMode,settings}){
      const listRef=useRef(null);
      useEffect(()=>{ listRef.current?.scrollTo({top:999999,behavior:'smooth'}) },[messages.length]);
      async function send(){
        const text=input.trim(); if(!text) return;
        const newMsgs=[...messages,userMsg(text)]; setMessages(newMsgs); setInput('');
        if(!aiMode) return;
        if(settings.apiKey && settings.model){
          try{ const reply = await callLLM(settings,newMsgs); setMessages(ms=>[...ms,botMsg(reply)]); }
          catch(e){ showError('API/CORS é”™è¯¯ï¼Œå·²åˆ‡æ¢åˆ°æœ¬åœ°å›å¤'); setMessages(ms=>[...ms,botMsg(localBrain(text))]); }
          return;
        }
        setMessages(ms=>[...ms,botMsg(localBrain(text))]);
      }
      return (
        <div className="rounded-2xl p-3 border border-white/10 flex flex-col gap-3" style={{background:'var(--glass)'}}>
          <div className="flex items-center justify-between">
            <div className="text-sm font-medium">èŠå¤©</div>
            <label className="text-xs opacity-80 flex items-center gap-1"><input type="checkbox" checked={aiMode} onChange={e=>setAiMode(e.target.checked)}/> AI å›å¤</label>
          </div>
          <div ref={listRef} className="h-96 overflow-auto flex flex-col gap-2 pr-1">
            {messages.map(m=>(
              <div key={m.id} className={`max-w-[86%] md:max-w-[70%] rounded-2xl px-3 py-2 text-sm leading-relaxed shadow border ${m.role==='user'?'self-end bg-[var(--accent)]/90 text-white border-[var(--accent)]/60':'self-start bg-white/5 text-white/90 border-white/10'}`}>{m.text}</div>
            ))}
          </div>
          <div className="flex items-center gap-2">
            <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=> e.key==='Enter' && (e.shiftKey?null:send())} placeholder="è¯´ç‚¹ä»€ä¹ˆâ€¦" className="flex-1 bg-white/10 rounded-xl px-3 py-2 text-sm border border-white/10 focus:outline-none"/>
            <button onClick={send} className="px-3 py-2 rounded-xl bg-[var(--accent)] text-white text-sm hover:opacity-90">å‘é€</button>
          </div>
          <div className="pt-2 border-t border-white/10 flex flex-wrap items-center gap-2 text-xs opacity-80">
            <TemplateChip onClick={t=>setMessages(ms=>[...ms,userMsg(t),botMsg(localBrain(t))])} label="å®‰æŠš" text="æŠ±æŠ±ä½ , å…ˆæ…¢æ…¢å‘¼å¸ã€‚"/>
            <TemplateChip onClick={t=>setMessages(ms=>[...ms,userMsg(t),botMsg(localBrain(t))])} label="é¼“åŠ±" text="ä½ å·²ç»åšå¾—å¾ˆå¥½äº†, ç»§ç»­ã€‚"/>
            <TemplateChip onClick={t=>setMessages(ms=>[...ms,userMsg(t),botMsg(localBrain(t))])} label="è°ƒä¾ƒ" text="ä»Šå¤©ä¹Ÿåœ¨ä¹±é£çš„å°çŒ«?"/>
          </div>
        </div>
      )
    }
    const TemplateChip = ({label,text,onClick}) => <button onClick={()=>onClick(text)} className="px-2 py-1 rounded-lg bg-white/10 hover:bg-white/15 border border-white/10">{label}</button>;

    // è®¾ç½®é¢æ¿ï¼šAPI / ç¾åŒ– / å­—ä½“ / æ‰‹æœºèƒŒæ™¯
    function SettingsPanel({settings,setSettings,theme,setTheme}){
      const [tab,setTab] = useState('api');
      const [temp,setTemp] = useState(()=>({ apiBase:'https://api.openai.com', apiKey:'', model:'', systemPrompt:'', characterName:'Valuri', avatar:'', temperature:0.6, ...settings }));
      const [tTheme,setTTheme] = useState(theme);
      const tempVal = Number.isFinite(+temp.temperature) ? +temp.temperature : 0.6;
      function saveAll(){ setSettings({ ...temp, temperature: tempVal }); setTheme(tTheme); }

      return (
        <div className="grid grid-cols-1 gap-3 text-sm">
          <div className="flex gap-1">
            <TabButton active={tab==='api'} onClick={()=>setTab('api')}>API</TabButton>
            <TabButton active={tab==='beauty'} onClick={()=>setTab('beauty')}>ç¾åŒ–</TabButton>
            <TabButton active={tab==='font'} onClick={()=>setTab('font')}>å­—ä½“</TabButton>
            <TabButton active={tab==='background'} onClick={()=>setTab('background')}>æ‰‹æœºèƒŒæ™¯</TabButton>
          </div>

          {tab==='api' && (
            <div className="rounded-xl border border-white/10 p-3 bg-white/5 space-y-3">
              <Row label="è§’è‰²å"><input value={temp.characterName} onChange={e=>setTemp({...temp,characterName:e.target.value})} className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10 focus:outline-none" placeholder="ä¾‹å¦‚ Valuri"/></Row>
              <Row label="å¤´åƒ URL"><input value={temp.avatar} onChange={e=>setTemp({...temp,avatar:e.target.value})} className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10 focus:outline-none" placeholder="http(s)://..."/></Row>
              <Row label="API Base"><input value={temp.apiBase} onChange={e=>setTemp({...temp,apiBase:e.target.value})} className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10 focus:outline-none" placeholder="https://api.openai.com"/></Row>
              <Row label="API Key"><input type="password" value={temp.apiKey} onChange={e=>setTemp({...temp,apiKey:e.target.value})} className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10 focus:outline-none" placeholder="sk-... å­˜åœ¨æœ¬åœ°"/></Row>
              <Row label="Model"><input value={temp.model} onChange={e=>setTemp({...temp,model:e.target.value})} className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10 focus:outline-none" placeholder="gpt-4o-mini æˆ–å…¶ä»–"/></Row>
              <div className="flex items-center gap-3">
                <label className="text-xs opacity-80">Temperature</label>
                <input type="range" min="0" max="2" step="0.1" value={tempVal} onChange={e=>setTemp({...temp,temperature:+e.target.value})}/>
                <span className="text-xs opacity-70 w-10">{tempVal.toFixed(1)}</span>
              </div>
              <label className="text-xs opacity-80">System Prompt</label>
              <textarea value={temp.systemPrompt} onChange={e=>setTemp({...temp,systemPrompt:e.target.value})} className="bg-white/10 rounded-lg px-3 py-2 border border-white/10 focus:outline-none min-h-[88px]"></textarea>
            </div>
          )}

          {tab==='beauty' && (
            <div className="rounded-xl border border-white/10 p-3 bg-white/5 space-y-3">
              <Row label="ä¸»é¢˜è‰²"><input type="color" value={tTheme.accent} onChange={e=>setTTheme({...tTheme,accent:e.target.value})} className="w-8 h-8 rounded"/></Row>
              <Row label="æ¯›ç»ç’ƒ"><input type="checkbox" checked={tTheme.glass} onChange={e=>setTTheme({...tTheme,glass:e.target.checked})}/></Row>
              <Row label="æ¨¡ç³Š"><input type="range" min="0" max="20" value={tTheme.blur} onChange={e=>setTTheme({...tTheme,blur:+e.target.value})}/> <span className="text-xs opacity-70 w-8 text-right">{tTheme.blur}</span></Row>
            </div>
          )}

          {tab==='font' && (
            <div className="rounded-xl border border-white/10 p-3 bg-white/5 space-y-3">
              <Row label="å­—ä½“æ ˆ"><input value={tTheme.font} onChange={e=>setTTheme({...tTheme,font:e.target.value})} placeholder="Inter, system-ui, ..." className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10 focus:outline-none"/></Row>
              <div className="flex flex-wrap gap-2 text-xs">
                {[
                  'Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto',
                  'Noto Serif SC, ui-serif, Georgia, serif',
                  'LXGW WenKai, system-ui, sans-serif',
                ].map(f=>(<button key={f} onClick={()=>setTTheme({...tTheme,font:f})} className="px-2 py-1 rounded bg-white/10 border border-white/10 hover:bg-white/15">{f.split(',')[0]}</button>))}
              </div>
              <div className="text-xs opacity-80">é¢„è§ˆï¼š<span style={{fontFamily:tTheme.font}} className="ml-1">æ˜¥é£åé‡Œï¼Œä¸å¦‚ä½ ã€‚</span></div>
            </div>
          )}

          {tab==='background' && (
            <div className="rounded-xl border border-white/10 p-3 bg-white/5 space-y-3">
              <Row label="ç±»å‹">
                <select value={tTheme.bgType} onChange={e=>setTTheme({...tTheme,bgType:e.target.value})} className="text-xs bg-white/10 px-2 py-1 rounded border border-white/10">
                  <option value="color">çº¯è‰²èƒŒæ™¯</option>
                  <option value="image">å›¾ç‰‡èƒŒæ™¯</option>
                </select>
              </Row>
              {tTheme.bgType==='color' ? (
                <Row label="é¢œè‰²"><input type="color" value={tTheme.bgColor} onChange={e=>setTTheme({...tTheme,bgColor:e.target.value})} className="w-8 h-8 rounded"/></Row>
              ) : (
                <Row label="å›¾ç‰‡">
                  <label className="text-xs bg-white/10 px-2 py-1 rounded border border-white/10 cursor-pointer">ä¸Šä¼ å›¾ç‰‡
                    <input type="file" accept="image/*" className="hidden" onChange={e=>fileToDataURL(e.target.files&&e.target.files[0]).then(url=>setTTheme({...tTheme,bgImage:url||''}))}/>
                  </label>
                  {tTheme.bgImage && <button onClick={()=>setTTheme({...tTheme,bgImage:''})} className="ml-2 text-xs px-2 py-1 rounded bg-white/10 border border-white/10">æ¸…é™¤</button>}
                </Row>
              )}
            </div>
          )}

          <div className="flex items-center justify-end gap-2">
            <button onClick={saveAll} className="text-xs px-3 py-1 rounded bg-[var(--accent)] text-white">ä¿å­˜</button>
          </div>
          <p className="mt-1 text-[11px] opacity-70">æç¤ºï¼šKey ä¿å­˜åœ¨æœ¬åœ°ã€‚æœ‹å‹è¦ç”¨å°±è‡ªå·±åœ¨â€œAPIâ€é‡Œå¡«ï¼Œä¸èµ°ä½ çš„ã€‚</p>
        </div>
      )
    }

    const Row = ({label,children}) => (<div className="flex items-center gap-3"><div className="w-20 shrink-0 text-xs opacity-80">{label}</div><div className="flex-1 flex items-center flex-wrap gap-2">{children}</div></div>);
    const TabButton = ({active,onClick,children}) => (<button onClick={onClick} className={`px-3 py-1.5 rounded-lg border text-xs ${active?'bg-white/15 border-white/20':'bg-white/5 border-white/10 hover:bg-white/10'}`}>{children}</button>);

    async function callLLM(settings,msgs){
      const m=[]; if(settings.systemPrompt) m.push({role:'system',content:settings.systemPrompt});
      for(const it of msgs){ m.push({role: it.role==='assistant'?'assistant':'user', content:it.text}); }
      const url=(settings.apiBase||'https://api.openai.com').replace(/\/$/,'')+'/v1/chat/completions';
      const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+settings.apiKey},body:JSON.stringify({model:settings.model,messages:m,temperature:settings.temperature??0.6,stream:false})});
      if(!res.ok) throw new Error('HTTP '+res.status+': '+await res.text());
      const json=await res.json();
      const content=json?.choices?.[0]?.message?.content;
      return (content||'').trim()||'(ç©ºå›å¤)';
    }

    // è‡ªæ£€
    try{
      console.assert(typeof uid()==='string' && uid().length>=3, 'uid ok');
      console.assert((()=>{const s='éŸ³ä¹æ¨è';return s.length>0})(), 'brain ok');
      console.log('[MiniPhone anti-black-screen] ready');
    }catch(e){ showError(e.message) }

    // å®‰å…¨æ¸²æŸ“ï¼šç­‰ä¾èµ–ç¡®å®å°±ç»ªå†æ¸²æŸ“ï¼Œç§»é™¤åŠ è½½å­—æ ·
    (function safeMount(){
      let tries=0;
      const t=setInterval(function(){
        tries++;
        if(window.React && window.ReactDOM && window.Babel){
          clearInterval(t);
          try{
            ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
            document.getElementById('loader').style.display='none';
          }catch(err){ showError(err.message) }
        }else if(tries>60){ // ~18s å…œåº•
          clearInterval(t);
          showError('ä¾èµ–åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•æˆ–æ›´æ¢ç½‘ç»œ');
        }
      }, 300);
    })();
  </script>
</body>
</html>
