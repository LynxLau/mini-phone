<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Mini Phone Â· Chat + Feeds + Music</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root { --accent:#7c5cff; }
    html,body{height:100%; background:#0a0a0a;}
    body{margin:0; display:grid; place-items:center; overflow:hidden;}
    .phone-wrap{height:100dvh; aspect-ratio:9/19.5; max-height:900px; max-width:min(520px, 100vw); padding:16px;}
    .panel { background: rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.08); }
    .btn { background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); }
    .btn:hover{ background: rgba(255,255,255,0.12); }
    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:20px; padding:8px 12px; border-radius:10px; background:#d33; color:#fff; font-size:12px; z-index:9999;}
    .bubble{word-break:break-word; white-space:pre-wrap;}
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="text/babel">
    const {useState,useEffect,useMemo,useRef} = React;

    /* ------------- Utils ------------- */
    const uid = () => Math.random().toString(36).slice(2,9);
    const loadJSON=(k,f)=>{try{const r=localStorage.getItem(k);return r?JSON.parse(r):f}catch{return f}};
    const saveJSON=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
    const toast=(m)=>{const el=document.createElement('div');el.className='toast';el.textContent=m;document.body.appendChild(el);setTimeout(()=>el.remove(),2200)};

    function colorToHex(c){ const ctx = document.createElement('canvas').getContext('2d'); ctx.fillStyle = c; const comp = ctx.fillStyle;
      if(comp.startsWith('#')) return comp; const m = comp.match(/rgba?\((\d+), ?(\d+), ?(\d+)/i);
      if(!m) return '#ffffff'; const to = n=> (+n).toString(16).padStart(2,'0'); return `#${to(m[1])}${to(m[2])}${to(m[3])}`;}

    /* ------------- App Shell ------------- */
    function App(){
      const [theme,setTheme]=useState(()=>loadJSON('mp_theme',{
        accent:'#7c5cff', bgType:'image', bgColor:'#0b0b0f', bgImage:'', blur:8, glass:true,
        font:'Inter, "Noto Sans SC", "PingFang SC", "Microsoft YaHei", system-ui, -apple-system, Segoe UI, Roboto'
      }));
      // å¤š API æ¡£ä½ï¼šå¯å¿«é€Ÿåˆ‡æ¢ä¸åŒç½‘å…³/æ¨¡å‹
      const [apiProfiles,setApiProfiles]=useState(()=>loadJSON('mp_api_profiles',[
        {id:uid(), name:'é»˜è®¤', apiBase:'https://api.skyi.cc/v1', apiKey:'', model:'gemini 2.5 pro', temperature:0.6}
      ]));
      const [activeProfileId,setActiveProfileId]=useState(()=>loadJSON('mp_active_profile', apiProfiles[0]?.id || null));

      const [characters,setCharacters]=useState(()=>loadJSON('mp_chars',[]));
      const [screen,setScreen]=useState('chat'); // é»˜è®¤ç›´è¿›èŠå¤©
      const activeProfile = useMemo(()=> apiProfiles.find(p=>p.id===activeProfileId) || apiProfiles[0], [apiProfiles,activeProfileId]);

      useEffect(()=>saveJSON('mp_theme',theme),[theme]);
      useEffect(()=>saveJSON('mp_api_profiles',apiProfiles),[apiProfiles]);
      useEffect(()=>saveJSON('mp_active_profile',activeProfileId),[activeProfileId]);
      useEffect(()=>saveJSON('mp_chars',characters),[characters]);

      return (
        <div className="phone-wrap w-full">
          <div className="relative w-full h-full rounded-[32px] border border-white/15 shadow-2xl overflow-hidden bg-black/80 text-white"
               style={{fontFamily:theme.font, backgroundImage: theme.bgType==='image' && theme.bgImage ? `url(${theme.bgImage})` : 'none', backgroundSize:'cover', backgroundPosition:'center'}}>
            <div className="absolute inset-0" style={{backdropFilter:`blur(${theme.blur}px)`}}/>
            <div className="absolute left-1/2 -translate-x-1/2 top-2 w-40 h-4 rounded-full bg-black/60 border border-white/10" />
            <div className="absolute inset-0 flex flex-col">
              {/* é¡¶éƒ¨çŠ¶æ€ */}
              <div className="p-3 flex items-center justify-between">
                <div className="text-xs text-white/80">{new Date().toTimeString().slice(0,5)}</div>
                <div className="flex items-center gap-2">
                  <select className="text-[11px] bg-black/50 border border-white/10 rounded px-2 py-1"
                          value={activeProfileId||''}
                          onChange={e=>setActiveProfileId(e.target.value)}>
                    {apiProfiles.map(p=><option key={p.id} value={p.id}>{p.name} Â· {p.model||'æœªè®¾æ¨¡å‹'}</option>)}
                  </select>
                  <button className="text-xs px-2 py-1 rounded btn" onClick={()=>setScreen('settings')}>âš™ï¸</button>
                </div>
              </div>

              {/* ä¸»ä½“é¡µ */}
              <div className="flex-1 overflow-auto px-4 pb-4 space-y-3">
                {screen==='chat' && <ChatPage theme={theme} characters={characters} setCharacters={setCharacters}
                  profile={activeProfile} setProfile={(patch)=>setApiProfiles(ps=>ps.map(p=>p.id===activeProfile.id?{...p,...patch}:p))} />}
                {screen==='xhs' && <XHSPage/>}
                {screen==='music' && <MusicPage/>}
                {screen==='moments' && <MomentsPage profile={activeProfile}/>}
                {screen==='settings' && <SettingsPage theme={theme} setTheme={setTheme}
                  apiProfiles={apiProfiles} setApiProfiles={setApiProfiles} activeProfileId={activeProfileId} setActiveProfileId={setActiveProfileId}
                />}
              </div>

              {/* Dock */}
              <div className="px-4 pb-5">
                <div className="panel rounded-2xl p-3 grid grid-cols-4 gap-2">
                  <DockBtn label="èŠå¤©" onClick={()=>setScreen('chat')}>ğŸ’¬</DockBtn>
                  <DockBtn label="å°çº¢ä¹¦" onClick={()=>setScreen('xhs')}>ğŸ“•</DockBtn>
                  <DockBtn label="éŸ³ä¹" onClick={()=>setScreen('music')}>ğŸµ</DockBtn>
                  <DockBtn label="æœ‹å‹åœˆ" onClick={()=>setScreen('moments')}>ğŸ«¶</DockBtn>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }
    const DockBtn=({children,label,onClick})=>(
      <button onClick={onClick} className="flex flex-col items-center gap-1">
        <div className="w-12 h-12 rounded-2xl panel grid place-items-center text-xl">{children}</div>
        <div className="text-xs opacity-90">{label}</div>
      </button>
    );

    /* ------------- Chat Page ------------- */
    function ChatPage({theme,characters,setCharacters,profile,setProfile}){
      const [selectedId,setSelectedId]=useState(()=>characters[0]?.id||null);
      const selected = useMemo(()=>characters.find(c=>c.id===selectedId)||null,[characters,selectedId]);

      const [drawerOpen,setDrawerOpen]=useState(false);

      // çº¿ä¸Š/çº¿ä¸‹
      const [chatMode,setChatMode]=useState('online'); // online | offline
      const [burstMin,setBurstMin]=useState(2);
      const [burstMax,setBurstMax]=useState(4);

      // æ¶ˆæ¯å†å² & è®°å¿†ï¼ˆæŒ‰è§’è‰²ï¼‰
      const storageKey = selected ? `mp_thread_${selected.id}` : null;
      const [msgs,setMsgs]=useState(()=> storageKey ? loadJSON(storageKey, []) : []);
      useEffect(()=>{ if(storageKey) saveJSON(storageKey,msgs) },[storageKey,msgs]);

      // UI per-role
      const [ui,setUi]=useState({user:'#7c5cff', bot:'rgba(255,255,255,0.08)', text:'#fff', font:''});

      // è§’è‰²æ•°æ®ï¼šå¡/ä¸–ç•Œä¹¦/é¢„è®¾ä¸æ­£åˆ™/æ¸©åº¦/è®°å¿†
      const [roleData,setRoleData]=useState({ roleCard:null, worldbook:null, presets:'', regex:'', temperature:0.6, memory:'' });
      // æ¯ä¸ªè§’è‰²è‡ªå·±çš„ API æ¨¡å‹è¦†ç›–ï¼ˆå¯ä¸å¡«ï¼‰
      const [roleModel,setRoleModel]=useState('');

      useEffect(()=>{
        if(!selected) return;
        const saved = loadJSON('mp_role_'+selected.id, null);
        if(saved){
          setUi(saved.ui||{user:'#7c5cff',bot:'rgba(255,255,255,0.08)',text:'#fff',font:''});
          setRoleData(saved.roleData||{});
          setChatMode(saved.chatMode||'online');
          setBurstMin(saved.burstMin ?? 2);
          setBurstMax(saved.burstMax ?? 4);
          setRoleModel(saved.roleModel||'');
          const loaded = loadJSON(`mp_thread_${selected.id}`, []);
          setMsgs(loaded);
        }else{
          setUi({user:colorToHex(getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#7c5cff'),bot:'rgba(255,255,255,0.08)',text:'#fff',font:''});
          setRoleData({ roleCard:null, worldbook:null, presets:'', regex:'', temperature:0.6, memory:'' });
          setMsgs([]);
        }
      },[selectedId]);

      useEffect(()=>{
        if(!selected) return;
        saveJSON('mp_role_'+selected.id,{ ui, roleData, chatMode, burstMin, burstMax, roleModel });
      },[selected, ui, roleData, chatMode, burstMin, burstMax, roleModel]);

      // API adapter
      async function chatComplete({ base, key, model, temperature, system, history, maxTokens }) {
        const b = (base||'').replace(/\/$/,''); const headers = { 'Content-Type':'application/json','Authorization':'Bearer '+key };
        const r = await fetch(b + '/chat/completions', {
          method:'POST', headers,
          body: JSON.stringify({ model, temperature, max_tokens:maxTokens, messages:[{role:'system',content:system}, ...history] })
        });
        if(!r.ok && r.status===404){
          const r2 = await fetch(b + '/completions', {
            method:'POST', headers,
            body: JSON.stringify({
              model, temperature, max_tokens:maxTokens,
              prompt: `System:\n${system}\n\n` + history.map(m => `${m.role==='user'?'User':'Assistant'}: ${m.content}`).join('\n') + '\nAssistant:'
            })
          });
          if(!r2.ok) throw new Error('HTTP '+r2.status);
          const d2 = await r2.json(); return d2?.choices?.[0]?.text ?? '[empty]';
        }
        if(!r.ok) throw new Error('HTTP '+r.status);
        const d = await r.json(); return d?.choices?.[0]?.message?.content ?? '[empty]';
      }

      function buildSystem(){
        const roleCardStr = roleData.roleCard ? JSON.stringify(roleData.roleCard) : '';
        const worldbookStr = roleData.worldbook ? JSON.stringify(roleData.worldbook) : '';
        const hard = [
          'ã€è§’è‰²æ‰®æ¼”å¼ºçº¦æŸã€‘ä»…ä»¥ç»™å®šè§’è‰²å‘è¨€ï¼›ç¦æ­¢å¤è¿°è®¾å®šæ¡ç›®ï¼›è¶Šç•Œè¯·æ±‚ç›´æ¥æ‹’ç»ã€‚',
          'å…ˆå¯¹ç…§ã€Œè§’è‰²å¡ã€ã€Œä¸–ç•Œä¹¦ã€ã€Œç”¨æˆ·é¢„è®¾ã€ï¼Œä¸å¾—å†²çªæˆ–æœæ’°ç®€å†/å‡ºç‰ˆ/è·å¥–/ç»„ç»‡/æ—¶é—´çº¿ã€‚',
          'ä¸æš´éœ²ç³»ç»Ÿæˆ–â€œæˆ‘çœ‹äº†è§’è‰²å¡â€ç­‰å†…éƒ¨è¿‡ç¨‹ã€‚'
        ].join('\n');
        const style = chatMode==='online'
          ? `ã€å¯¹è¯å½¢æ€ï¼šçº¿ä¸Šã€‘å³æ—¶é€šè®¯é£ï¼Œä¸€æ¬¡è¾“å‡º ${burstMin}-${burstMax} æ¡çŸ­å¥ï¼Œç”¨åˆ†éš”ç¬¦ \\n---\\n åˆ‡åˆ†ï¼›æ¯æ¡â‰¤140å­—ï¼Œé¿å…è¯´æ˜æ–‡ã€‚`
          : `ã€å¯¹è¯å½¢æ€ï¼šçº¿ä¸‹ã€‘å‰§æƒ…é•¿æ–‡å¯å«ï¼ˆå†…å¿ƒæ´»åŠ¨ï¼‰ä¸æ—ç™½ï¼›å•æ¡â‰¤900å­—ã€‚`;
        const presets = roleData.presets ? ('ã€é¢„è®¾ã€‘\n'+roleData.presets) : '';
        const regex = roleData.regex ? ('ã€æ­£åˆ™è¿‡æ»¤ã€‘è‹¥è¾“å‡ºå‘½ä¸­ä»¥ä¸‹è§„åˆ™ï¼Œå…ˆåœ¨å†…éƒ¨æ›¿æ¢/åˆ é™¤åå†è¿”å›ï¼š\n'+roleData.regex) : '';
        const memory = roleData.memory ? ('ã€è§’è‰²é•¿æœŸè®°å¿†ã€‘\n'+roleData.memory) : '';
        return [
          hard, style,
          'ã€ä¿¡æ¯æ¥æºç™½åå•ã€‘ä»…å¯å¼•ç”¨ï¼šè§’è‰²å¡ã€ä¸–ç•Œä¹¦ã€ç”¨æˆ·é¢„è®¾/è®°å¿†ã€å…¨å±€ Systemã€‚',
          'ã€ç¤ºä¾‹ã€‘\nç”¨æˆ·ï¼šåœ¨å¹²å˜›ï¼Ÿ\nçº¿ä¸Šï¼šï¼ˆå¤šæ¡çŸ­å¥ï¼‰â€œåœ¨ç‰‡åœºã€‚â€\\n---\\nâ€œååˆ†é’Ÿåæ”¶å·¥ã€‚â€\\n---\\nâ€œä½ åˆ°å“ªäº†ï¼Ÿâ€\nçº¿ä¸‹ï¼šï¼ˆå†…å¿ƒ+å¯¹ç™½ï¼‰ï¼ˆå’–å•¡å‡‰é€ï¼‰â€œç­‰ä½ ã€‚â€',
          roleCardStr ? ('ã€è§’è‰²å¡ã€‘\n'+roleCardStr):'',
          worldbookStr ? ('ã€ä¸–ç•Œä¹¦ã€‘\n'+worldbookStr):'',
          presets, memory, regex
        ].filter(Boolean).join('\n\n');
      }

      // å‘é€æ–‡æœ¬/å›¾ç‰‡/è¡¨æƒ…
      async function sendText(text){
        if(!text?.trim()) return;
        const history = [...msgs, {role:'user',content:text,id:uid()}];
        setMsgs(history);
        const apiBase = profile.apiBase, apiKey = profile.apiKey;
        const modelToUse = roleModel || profile.model;
        if(!apiBase || !apiKey || !modelToUse){ toast('API æœªè®¾ç½®å®Œæ•´'); return; }
        const maxChars = chatMode==='online' ? 140 : 900;
        const approxTokens = Math.max(64, Math.min(1024, Math.round(maxChars*1.8)));
        const systemPayload = buildSystem();
        try{
          const content = await chatComplete({
            base: apiBase, key: apiKey, model: modelToUse,
            temperature: Number.isFinite(+roleData.temperature)? +roleData.temperature : (+profile.temperature||0.6),
            system: systemPayload, history: history.map(({role,content})=>({role,content})), maxTokens: approxTokens
          });
          // æ‹†åˆ†
          if(chatMode==='online'){
            const parts = String(content).split(/\n---\n/).map(s=>s.trim()).filter(Boolean);
            const n = Math.max(burstMin, Math.min(burstMax, parts.length || burstMin));
            setMsgs(m=>{
              const base=[...m];
              for(let i=0;i<n;i++) base.push({id:uid(), role:'assistant', content:parts[i]||''});
              return base;
            });
          }else{
            setMsgs(m=>[...m,{id:uid(), role:'assistant', content:String(content).trim()}]);
          }
        }catch(e){ toast('è¯·æ±‚å¤±è´¥ï¼š'+(e.message||e)) }
      }

      function sendImage(file){
        const r = new FileReader();
        r.onload=()=> setMsgs(m=>[...m,{id:uid(), role:'user', type:'image', url:r.result}]);
        r.readAsDataURL(file);
      }
      function sendSticker(text){ setMsgs(m=>[...m,{id:uid(), role:'user', type:'sticker', content:text}]); }

      async function buildMemory(){
        const apiBase = profile.apiBase, apiKey = profile.apiKey, modelToUse = roleModel || profile.model;
        if(!apiBase || !apiKey || !modelToUse){ toast('API æœªè®¾ç½®å®Œæ•´'); return; }
        const recent = msgs.slice(-30).map(m=>`${m.role==='user'?'ç”¨æˆ·':'è§’è‰²'}: ${m.type?'[åª’ä½“]':m.content}`).join('\n');
        const prompt = [
          'è¯·ä»ä»¥ä¸‹å¯¹è¯ä¸­æç‚¼ã€Œé•¿æœŸç¨³å®šã€ä¸æ˜“å˜åŒ–ã€å¯¹æŒç»­æ‰®æ¼”æœ€é‡è¦ã€çš„ä¿¡æ¯ï¼Œè¾“å‡º 3-8 æ¡ bulletï¼š',
          '- äººé™…å…³ç³»ä¸èº«ä»½æ ‡ç­¾ï¼ˆéå…«å¦ï¼‰',
          '- ç¨³å®šçš„æ€§æ ¼/å£å¤´ç¦…/è¾¹ç•Œ',
          '- æ˜ç¡®ç›®æ ‡ä¸ç¦å¿Œ',
          '- å·²è¾¾æˆçš„å…³é”®äº‹å®ï¼ˆä¸å¯æé€ ï¼‰',
          'ç¦æ­¢å¤è¿°ç»†èŠ‚å‰§æƒ…ï¼Œç¦æ­¢ç¼–é€ ã€‚ä¸­æ–‡è¾“å‡ºã€‚',
          'å¯¹è¯ï¼š\n'+recent
        ].join('\n');
        try{
          const content = await chatComplete({
            base: apiBase, key: apiKey, model: modelToUse,
            temperature: 0.2, maxTokens: 400,
            system: 'ä½ æ˜¯ä¸¥è°¨çš„å¯¹è¯å½’çº³å™¨ï¼Œåªè¾“å‡ºè¦ç‚¹åˆ—è¡¨ã€‚',
            history: [{role:'user',content:prompt}]
          });
          setRoleData(d=>({...d, memory: String(content).trim()}));
          toast('å·²å†™å…¥é•¿æœŸè®°å¿†');
        }catch(e){ toast('è®°å¿†ç”Ÿæˆå¤±è´¥ï¼š'+(e.message||e)) }
      }

      // UI ç»„ä»¶
      return (
        <div className="space-y-3">
          <div className="flex items-center justify-between">
            <div className="text-sm">
              {selected ? <>å½“å‰ï¼š<span className="font-medium">{selected.name}</span></> : 'è¯·é€‰æ‹©ä¸€ä¸ªè§’è‰²'}
            </div>
            <div className="flex items-center gap-2">
              <select className="text-xs bg-white/10 border border-white/10 rounded px-2 py-1"
                      value={selectedId||''} onChange={e=>setSelectedId(e.target.value)}>
                <option value="" disabled>é€‰æ‹©è§’è‰²</option>
                {characters.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
              </select>
              <button className="btn px-2 py-1 rounded text-xs" onClick={()=>setDrawerOpen(true)}>è®¾ç½®</button>
              <button className="btn px-2 py-1 rounded text-xs" onClick={()=>{
                const name=prompt('è§’è‰²æ˜µç§°'); if(!name) return;
                const c={id:uid(), name}; setCharacters([...characters,c]); setSelectedId(c.id);
              }}>ï¼‹</button>
            </div>
          </div>

          {selected && (
            <div className="panel rounded-2xl border border-white/10 overflow-hidden">
              <div className="h-[60vh] flex flex-col">
                <AutoScrollList items={msgs} render={(m)=><MessageBubble key={m.id} m={m} ui={ui} />} />
                <div className="sticky bottom-0 border-t border-white/10 bg-black/60 backdrop-blur px-3 py-2">
                  <Composer onSend={sendText} onImage={sendImage} onSticker={sendSticker}/>
                </div>
              </div>
            </div>
          )}

          {/* æŠ½å±‰ï¼šè§’è‰²ç‹¬ç«‹è®¾ç½® */}
          {selected && drawerOpen && (
            <SideDrawer onClose={()=>setDrawerOpen(false)} title={`è®¾ç½® Â· ${selected.name}`}>
              <section className="space-y-2">
                <h4 className="text-sm font-medium">å¯¹è¯å½¢æ€</h4>
                <div className="flex gap-2 text-xs">
                  {['online','offline'].map(v=>(
                    <label key={v} className={`px-2 py-1 rounded cursor-pointer ${chatMode===v?'bg-white/15':'bg-white/5'}`}>
                      <input type="radio" className="mr-1" checked={chatMode===v} onChange={()=>setChatMode(v)}/>
                      {v==='online'?'çº¿ä¸Šï¼ˆ2â€“5æ¡çŸ­å¥ï¼‰':'çº¿ä¸‹ï¼ˆå‰§æƒ…é•¿æ–‡ï¼‰'}
                    </label>
                  ))}
                </div>
                {chatMode==='online' && (
                  <div className="flex items-center gap-2 text-xs">
                    <span className="opacity-80">æ¯æ¬¡æ¡æ•°</span>
                    <input type="number" min="1" max="5" value={burstMin} onChange={e=>setBurstMin(Math.max(1,Math.min(5,+e.target.value||2)))} className="w-14 bg-white/10 border border-white/10 rounded px-1"/>
                    <span>åˆ°</span>
                    <input type="number" min="1" max="5" value={burstMax} onChange={e=>setBurstMax(Math.max(1,Math.min(5,+e.target.value||4)))} className="w-14 bg-white/10 border border-white/10 rounded px-1"/>
                  </div>
                )}
              </section>

              <Hr/>

              <section className="space-y-2">
                <h4 className="text-sm font-medium">ç¾åŒ–</h4>
                <Row label="ç”¨æˆ·æ°”æ³¡"><input type="color" value={ui.user} onChange={e=>setUi({...ui,user:e.target.value})} /></Row>
                <Row label="è§’è‰²æ°”æ³¡"><input type="color" value={colorToHex(ui.bot)} onChange={e=>setUi({...ui,bot:e.target.value})} /></Row>
                <Row label="æ–‡å­—é¢œè‰²"><input type="color" value={ui.text} onChange={e=>setUi({...ui,text:e.target.value})} /></Row>
                <Row label="å­—ä½“æ ˆ"><input className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10" value={ui.font} onChange={e=>setUi({...ui,font:e.target.value})} placeholder='Inter, Noto Sans SC, PingFang SC, Microsoft YaHei'/></Row>
              </section>

              <Hr/>

              <section className="space-y-2">
                <h4 className="text-sm font-medium">è§’è‰²æ•°æ®</h4>
                <Row label="è§’è‰²å¡">
                  <UploadJSON onLoad={(obj)=>setRoleData(d=>({...d, roleCard:obj}))}/>
                </Row>
                <Row label="ä¸–ç•Œä¹¦">
                  <UploadJSON onLoad={(obj)=>setRoleData(d=>({...d, worldbook:obj}))}/>
                </Row>
                <div className="text-[11px] opacity-70">ä¹Ÿå¯ç›´æ¥ç²˜è´´ JSON</div>
                <textarea className="w-full h-20 bg-black/60 border border-white/10 rounded p-2 text-xs font-mono"
                          placeholder='ç²˜è´´ è§’è‰²å¡ JSONï¼ˆå¯ç©ºï¼‰'
                          value={roleData.roleCard?JSON.stringify(roleData.roleCard,null,2):''}
                          onChange={e=>setRoleData(d=>({...d, roleCard: safeParse(e.target.value,null)}))}/>
                <textarea className="w-full h-20 bg-black/60 border border-white/10 rounded p-2 text-xs font-mono"
                          placeholder='ç²˜è´´ ä¸–ç•Œä¹¦ JSONï¼ˆå¯ç©ºï¼‰'
                          value={roleData.worldbook?JSON.stringify(roleData.worldbook,null,2):''}
                          onChange={e=>setRoleData(d=>({...d, worldbook: safeParse(e.target.value,null)}))}/>
                <Row label="é¢„è®¾"><textarea className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10 min-h-[60px]"
                          value={roleData.presets||''} onChange={e=>setRoleData(d=>({...d,presets:e.target.value}))}/></Row>
                <Row label="æ­£åˆ™"><textarea className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10 min-h-[60px]"
                          placeholder="ä¸€è¡Œä¸€æ¡ï¼›å½¢å¦‚ï¼šs/è¦æ›¿æ¢çš„/æ›¿æ¢å/g"
                          value={roleData.regex||''} onChange={e=>setRoleData(d=>({...d,regex:e.target.value}))}/></Row>
                <Row label="æ¸©åº¦"><input type="number" step="0.1" min="0" max="2" value={roleData.temperature??0.6}
                          onChange={e=>setRoleData(d=>({...d,temperature:+e.target.value||0}))} className="w-20 bg-white/10 border border-white/10 rounded px-2 py-1"/></Row>
                <Row label="æ¨¡å‹è¦†ç›–"><input className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10" placeholder={`ä¼˜å…ˆäºæ¡£ä½ï¼š${profile.model||'æœªè®¾'}`}
                          value={roleModel} onChange={e=>setRoleModel(e.target.value)}/></Row>
              </section>

              <Hr/>

              <section className="space-y-2">
                <h4 className="text-sm font-medium">é•¿æœŸè®°å¿†</h4>
                <textarea className="w-full h-24 bg-black/60 border border-white/10 rounded p-2 text-xs"
                          value={roleData.memory||''} onChange={e=>setRoleData(d=>({...d,memory:e.target.value}))}
                          placeholder="AI æ€»ç»“å‡ºçš„ä¸å˜è¦ç‚¹ï¼Œä½œä¸ºäººè®¾åšå›ºå±‚ã€‚"/>
                <div className="flex gap-2">
                  <button className="px-3 py-1 rounded bg-[var(--accent)] text-white text-xs" onClick={buildMemory}>ä»æœ€è¿‘å¯¹è¯ç”Ÿæˆ</button>
                  <button className="px-3 py-1 rounded btn text-xs" onClick={()=>{setRoleData(d=>({...d,memory:''})); toast('å·²æ¸…ç©ºè®°å¿†')}}>æ¸…ç©º</button>
                </div>
              </section>
            </SideDrawer>
          )}
        </div>
      );
    }

    const safeParse=(t,d)=>{try{return JSON.parse(t)}catch{return d}};
    const Hr=()=> <div className="my-3 h-px bg-white/10"/>;

    function SideDrawer({title,onClose,children}){
      return (
        <div className="fixed inset-0 z-50">
          <div className="absolute inset-0 bg-black/50" onClick={onClose}/>
          <div className="absolute right-0 top-0 h-full w-[88%] max-w-sm bg-black/90 border-l border-white/10 p-3 overflow-auto">
            <div className="flex items-center justify-between mb-2">
              <div className="text-sm font-medium">{title}</div>
              <button className="btn px-2 py-1 rounded text-xs" onClick={onClose}>å…³é—­</button>
            </div>
            {children}
          </div>
        </div>
      );
    }

    function UploadJSON({onLoad}){
      return (
        <label className="text-xs btn px-2 py-1 rounded cursor-pointer inline-flex items-center gap-2">
          å¯¼å…¥JSON
          <input type="file" accept=".json,application/json" className="hidden"
                 onChange={async e=>{
                   const f=e.target.files&&e.target.files[0]; if(!f) return;
                   try{ const text=await f.text(); const obj=JSON.parse(text); onLoad && onLoad(obj); toast('å·²åŠ è½½'); }
                   catch(err){ toast('è§£æå¤±è´¥ï¼š'+err.message) }
                 }}/>
        </label>
      );
    }

    function AutoScrollList({items, render}){
      const ref = useRef(null);
      useEffect(()=>{ const el=ref.current; if(!el) return;
        const nearBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 120;
        if(nearBottom) el.scrollTop = el.scrollHeight;
      },[items]);
      return <div ref={ref} className="flex-1 min-h-0 overflow-auto px-3 py-3 space-y-2">{items.map(render)}</div>;
    }

    function MessageBubble({m,ui}){
      const baseStyle = { color: ui.text, fontFamily: ui.font || undefined };
      if(m.type==='image'){
        return (
          <div className={`max-w-[85%] rounded-2xl border ${m.role==='user'?'ml-auto':'mr-auto'}`} style={{borderColor:'rgba(255,255,255,.18)'}}>
            <img src={m.url} className="max-w-[70vw] rounded-2xl" alt="img"/>
          </div>
        );
      }
      if(m.type==='sticker'){
        return (
          <div className={`max-w-[85%] px-3 py-2 rounded-2xl text-lg ${m.role==='user'?'ml-auto':'mr-auto'}`} style={{background:m.role==='user'?ui.user:'transparent',...baseStyle}}>
            {m.content}
          </div>
        );
      }
      return (
        <div className={`max-w-[85%] px-3 py-2 rounded-2xl text-sm leading-snug border bubble ${m.role==='user'?'ml-auto text-white':'mr-auto text-white/90'}`}
             style={{ background: m.role==='user'?ui.user:'rgba(255,255,255,0.08)', borderColor: m.role==='user'?'rgba(124,92,255,.6)':'rgba(255,255,255,.18)', ...baseStyle }}>
          {m.content}
        </div>
      );
    }

    function Composer({onSend,onImage,onSticker}){
      const [v,setV]=useState('');
      const fileRef = useRef(null);
      const stickers = ['ğŸ˜','ğŸ¥¹','ğŸ« ','ğŸ¤Œ','ğŸ¥°','ğŸ”¥','ğŸ«¶','ğŸ™„','ğŸ˜­','ğŸ˜´','ğŸ¤','ğŸ–¤','âœ¨','ğŸ˜®â€ğŸ’¨'];
      return (
        <div className="flex items-center gap-2">
          <button className="btn px-2 py-2 rounded" onClick={()=>fileRef.current?.click()}>ğŸ–¼ï¸</button>
          <input type="file" ref={fileRef} accept="image/*" className="hidden" onChange={e=>{const f=e.target.files?.[0]; if(f) onImage&&onImage(f);}}/>
          <details className="relative">
            <summary className="btn px-2 py-2 rounded cursor-pointer select-none">ğŸ™‚</summary>
            <div className="absolute bottom-10 left-0 grid grid-cols-7 gap-1 p-2 rounded-xl bg-black/90 border border-white/10">
              {stickers.map(s=> <button key={s} className="px-2 py-1 hover:bg-white/10 rounded" onClick={()=>onSticker&&onSticker(s)}>{s}</button>)}
            </div>
          </details>
          <input className="flex-1 bg-white/10 rounded-xl px-3 py-2 text-sm border border-white/10 focus:outline-none"
                 placeholder="è¯´ç‚¹ä»€ä¹ˆâ€¦" value={v} onChange={e=>setV(e.target.value)}
                 onKeyDown={e=>{ if(e.key==='Enter' && !e.shiftKey){ onSend(v); setV(''); }}}/>
          <button className="px-3 py-2 rounded-xl bg-[var(--accent)] text-white text-sm" onClick={()=>{onSend(v); setV('')}}>å‘é€</button>
        </div>
      );
    }

    /* ------------- XHS (å°çº¢ä¹¦) ------------- */
    function XHSPage(){
      const [url,setUrl]=useState('https://www.xiaohongshu.com/explore');
      const [embedOk,setEmbedOk]=useState(true);
      useEffect(()=>{
        // ç®€å•æ¢æµ‹ï¼šè¯•å›¾åŠ è½½ï¼Œè‹¥ onload/onerror å‘Šè­¦åˆ™æç¤ºå¤–å¼€
      },[url]);
      return (
        <div className="space-y-3">
          <Header title="å°çº¢ä¹¦" />
          <div className="panel rounded-2xl p-3 space-y-2">
            <div className="text-xs opacity-80">æç¤ºï¼šè‹¥ç«™ç‚¹ä¸å…è®¸å†…åµŒï¼Œä¼šè‡ªåŠ¨åœ¨æ–°çª—å£æ‰“å¼€ã€‚</div>
            <div className="flex gap-2">
              <input className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10 text-sm" value={url} onChange={e=>setUrl(e.target.value)}/>
              <button className="btn px-3 py-1.5 rounded text-sm" onClick={()=>{
                try{
                  const f=document.getElementById('xhs_iframe');
                  if(f) f.src=url;
                  setEmbedOk(true);
                  setTimeout(()=>{ // ç²—ç³™å…œåº•ï¼šè‹¥ 1.2s å†…æœªèƒ½ä¸ iframe é€šä¿¡ï¼Œæ”¹å¤–å¼€
                    if(!f || !f.contentWindow){ window.open(url,'_blank'); setEmbedOk(false); }
                  },1200);
                }catch{ window.open(url,'_blank'); setEmbedOk(false); }
              }}>æ‰“å¼€</button>
            </div>
            {embedOk
              ? <iframe id="xhs_iframe" title="xhs" src={url} className="w-full h-[64vh] rounded-xl border border-white/10"></iframe>
              : <div className="text-xs opacity-80">å·²åœ¨æ–°çª—å£æ‰“å¼€ã€‚</div>}
          </div>
        </div>
      );
    }

    /* ------------- Music ------------- */
    function MusicPage(){
      const [embed,setEmbed]=useState('<iframe frameborder="0" border="0" marginwidth="0" marginheight="0" width="100%" height="380" src=""></iframe>');
      const [audioUrl,setAudioUrl]=useState('');
      return (
        <div className="space-y-3">
          <Header title="éŸ³ä¹"/>
          <div className="panel rounded-2xl p-3 space-y-2">
            <div className="text-sm font-medium">æ–¹å¼ä¸€ï¼šç²˜è´´å®˜æ–¹ iframeï¼ˆQQéŸ³ä¹/ç½‘æ˜“äº‘æ”¯æŒï¼‰</div>
            <textarea className="w-full min-h-[100px] bg-black/60 border border-white/10 rounded p-2 text-xs font-mono"
                      placeholder='ç²˜è´´å®˜æ–¹æ’­æ”¾å™¨ iframe ä»£ç '
                      value={embed} onChange={e=>setEmbed(e.target.value)} />
            <div className="rounded-xl border border-white/10 p-2" dangerouslySetInnerHTML={{__html:embed}}/>
            <div className="text-sm font-medium mt-3">æ–¹å¼äºŒï¼šç›´é“¾éŸ³é¢‘</div>
            <div className="flex gap-2">
              <input className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10 text-sm" placeholder="https://..." value={audioUrl} onChange={e=>setAudioUrl(e.target.value)}/>
              <audio controls src={audioUrl||undefined} className="flex-1"/>
            </div>
          </div>
        </div>
      );
    }

    /* ------------- Moments/Weibo ------------- */
    function MomentsPage({profile}){
      const [posts,setPosts]=useState(()=>loadJSON('mp_moments',[]));
      useEffect(()=>saveJSON('mp_moments',posts),[posts]);

      const [text,setText]=useState('');
      const [img,setImg]=useState(null);
      const fileRef = useRef(null);

      async function aiPost(seed){
        const base=(profile.apiBase||'').replace(/\/$/,''); if(!profile.apiKey||!profile.model) return toast('API æ¡£ä½æœªè®¾å®Œæ•´');
        const headers={'Content-Type':'application/json','Authorization':'Bearer '+profile.apiKey};
        const sys='ä½ æ˜¯ç¤¾äº¤å¹³å°æ–‡æ¡ˆåŠ©æ‰‹ï¼Œå†™ 40-120 å­—ä¸­æ–‡è´´æ–‡ï¼Œå£è¯­è‡ªç„¶ï¼Œæ‹’ç»è¥é”€è…”ã€‚';
        const prompt='æ ¹æ®å…³é”®è¯å†™ä¸€æ¡æœ‹å‹åœˆå†…å®¹ï¼Œé¿å…é¸¡æ±¤ï¼š\nå…³é”®è¯ï¼š'+seed;
        const r = await fetch(base + '/chat/completions',{method:'POST',headers,body:JSON.stringify({model:profile.model,temperature:0.7,max_tokens:220,messages:[{role:'system',content:sys},{role:'user',content:prompt}]})});
        if(!r.ok){ toast('AI å‘å¸–å¤±è´¥'); return; }
        const d=await r.json(); const c=d?.choices?.[0]?.message?.content||'';
        setPosts([{id:uid(), text:c, time:Date.now()}, ...posts]);
      }

      async function aiComment(post){
        const base=(profile.apiBase||'').replace(/\/$/,''); if(!profile.apiKey||!profile.model) return toast('API æ¡£ä½æœªè®¾å®Œæ•´');
        const headers={'Content-Type':'application/json','Authorization':'Bearer '+profile.apiKey};
        const sys='ä½ æ˜¯ç¤¾äº¤å¹³å°è¯„è®ºåŠ©æ‰‹ï¼Œå†™ 10-40 å­—ä¸­æ–‡è¯„è®ºï¼Œä¸å¥‰æ‰¿ï¼Œä¸é˜´é˜³æ€ªæ°”ã€‚';
        const prompt='é’ˆå¯¹è¿™æ¡å†…å®¹å†™è¯„è®ºï¼š\n'+post.text;
        const r = await fetch(base + '/chat/completions',{method:'POST',headers,body:JSON.stringify({model:profile.model,temperature:0.7,max_tokens:120,messages:[{role:'system',content:sys},{role:'user',content:prompt}]})});
        if(!r.ok){ toast('AI è¯„è®ºå¤±è´¥'); return; }
        const d=await r.json(); const c=d?.choices?.[0]?.message?.content||'';
        setPosts(ps=>ps.map(p=> p.id===post.id ? {...p, comments:[...(p.comments||[]), {id:uid(), text:c}]} : p ));
      }

      return (
        <div className="space-y-3">
          <Header title="æœ‹å‹åœˆ / å¾®åš"/>
          <div className="panel rounded-2xl p-3 space-y-2">
            <div className="flex gap-2">
              <input className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10 text-sm" placeholder="æ­¤åˆ»æƒ³è¯´ç‚¹ä»€ä¹ˆâ€¦" value={text} onChange={e=>setText(e.target.value)}/>
              <button className="btn px-3 py-1.5 rounded" onClick={()=>fileRef.current?.click()}>ğŸ–¼ï¸</button>
              <input ref={fileRef} type="file" accept="image/*" className="hidden" onChange={e=>{
                const f=e.target.files?.[0]; if(!f) return;
                const r=new FileReader(); r.onload=()=>setImg(r.result); r.readAsDataURL(f);
              }}/>
              <button className="px-3 py-1.5 rounded bg-[var(--accent)] text-white" onClick={()=>{
                if(!text && !img) return;
                setPosts([{id:uid(), text, img, time:Date.now()}, ...posts]); setText(''); setImg(null);
              }}>å‘å¸ƒ</button>
              <button className="btn px-3 py-1.5 rounded" onClick={()=>aiPost('ä»Šå¤©çš„å¿ƒæƒ…ä¸æœ€è¿‘çš„å°ç›®æ ‡')}>ç”± AI å‘å¸ƒ</button>
            </div>
            {img && <img src={img} className="max-h-32 rounded mt-2" alt="preview"/>}
          </div>

          <div className="space-y-3 max-h-[58vh] overflow-auto">
            {posts.map(p=>(
              <div key={p.id} className="panel rounded-2xl p-3">
                <div className="text-xs opacity-70">{new Date(p.time).toLocaleString()}</div>
                <div className="mt-1 text-sm leading-snug whitespace-pre-wrap">{p.text}</div>
                {p.img && <img src={p.img} className="rounded mt-2" alt="img"/>}
                <div className="mt-2">
                  <button className="btn px-2 py-1 rounded text-xs" onClick={()=>aiComment(p)}>AI è¯„è®º</button>
                </div>
                {(p.comments||[]).length>0 && (
                  <div className="mt-2 space-y-1">
                    {p.comments.map(c=> <div key={c.id} className="text-xs bg-white/5 border border-white/10 rounded px-2 py-1">{c.text}</div>)}
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* ------------- Settings ------------- */
    function SettingsPage({theme,setTheme,apiProfiles,setApiProfiles,activeProfileId,setActiveProfileId}){
      const [tab,setTab]=useState('api');
      const [tTheme,setTTheme]=useState(theme);
      useEffect(()=>setTheme(tTheme),[tTheme,setTheme]);

      return (
        <div className="space-y-3">
          <Header title="è®¾ç½®"/>
          <div className="flex gap-1">
            <TabButton active={tab==='api'} onClick={()=>setTab('api')}>API æ¡£ä½</TabButton>
            <TabButton active={tab==='beauty'} onClick={()=>setTab('beauty')}>å…¨å±€ç¾åŒ–</TabButton>
            <TabButton active={tab==='bg'} onClick={()=>setTab('bg')}>æ‰‹æœºèƒŒæ™¯</TabButton>
          </div>

          {tab==='api' && (
            <div className="rounded-xl border border-white/10 p-3 bg-white/5 space-y-3">
              <div className="flex items-center justify-between">
                <div className="text-sm">æ¡£ä½ï¼ˆ{apiProfiles.length}ï¼‰</div>
                <button className="btn px-2 py-1 rounded text-xs" onClick={()=>{
                  const p={id:uid(), name:'æ–°æ¡£ä½', apiBase:'', apiKey:'', model:'', temperature:0.6};
                  setApiProfiles([...apiProfiles, p]); setActiveProfileId(p.id);
                }}>ï¼‹ æ–°å»ºæ¡£ä½</button>
              </div>
              <div className="space-y-2">
                {apiProfiles.map(p=>(
                  <div key={p.id} className={`p-2 rounded border ${activeProfileId===p.id?'border-[var(--accent)]/60 bg-white/10':'border-white/10 bg-white/5'}`}>
                    <div className="flex items-center justify-between">
                      <input className="text-sm bg-transparent outline-none" value={p.name} onChange={e=>setApiProfiles(ps=>ps.map(x=>x.id===p.id?{...x,name:e.target.value}:x))}/>
                      <div className="flex items-center gap-2">
                        <label className="text-[11px] flex items-center gap-1"><input type="radio" checked={activeProfileId===p.id} onChange={()=>setActiveProfileId(p.id)}/> ä½¿ç”¨</label>
                        <button className="btn px-2 py-1 rounded text-xs" onClick={()=>setApiProfiles(ps=>ps.filter(x=>x.id!==p.id))}>åˆ é™¤</button>
                      </div>
                    </div>
                    <div className="grid grid-cols-1 gap-2 mt-2 text-xs">
                      <Row label="API Base"><input className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10" value={p.apiBase} onChange={e=>setApiProfiles(ps=>ps.map(x=>x.id===p.id?{...x,apiBase:e.target.value}:x))}/></Row>
                      <Row label="API Key"><input type="password" className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10" value={p.apiKey} onChange={e=>setApiProfiles(ps=>ps.map(x=>x.id===p.id?{...x,apiKey:e.target.value}:x))}/></Row>
                      <Row label="æ¨¡å‹"><input className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10" value={p.model} onChange={e=>setApiProfiles(ps=>ps.map(x=>x.id===p.id?{...x,model:e.target.value}:x))}/></Row>
                      <Row label="æ¸©åº¦"><input type="number" step="0.1" min="0" max="2" className="w-20 bg-white/10 rounded px-2 py-1 border border-white/10" value={p.temperature} onChange={e=>setApiProfiles(ps=>ps.map(x=>x.id===p.id?{...x,temperature:+e.target.value||0}:x))}/></Row>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {tab==='beauty' && (
            <div className="rounded-xl border border-white/10 p-3 bg-white/5 space-y-3">
              <Row label="ä¸»é¢˜è‰²"><input type="color" value={tTheme.accent} onChange={e=>setTTheme({...tTheme,accent:e.target.value})} className="w-8 h-8 rounded"/></Row>
              <Row label="æ¨¡ç³Š"><input type="range" min="0" max="20" value={tTheme.blur} onChange={e=>setTTheme({...tTheme,blur:+e.target.value})}/> <span className="text-xs opacity-90 w-8 text-right">{tTheme.blur}</span></Row>
              <Row label="å­—ä½“æ ˆ"><input className="flex-1 bg-white/10 rounded px-2 py-1 border border-white/10" value={tTheme.font} onChange={e=>setTTheme({...tTheme,font:e.target.value})}/></Row>
            </div>
          )}

          {tab==='bg' && (
            <div className="rounded-xl border border-white/10 p-3 bg-white/5 space-y-3">
              <Row label="ç±»å‹">
                <select value={theme.bgType} onChange={e=>setTheme({...theme,bgType:e.target.value})} className="text-xs bg-white/10 px-2 py-1 rounded border border-white/10">
                  <option value="color">çº¯è‰²èƒŒæ™¯</option>
                  <option value="image">å›¾ç‰‡èƒŒæ™¯</option>
                </select>
              </Row>
              {theme.bgType==='color' ? (
                <Row label="é¢œè‰²"><input type="color" value={theme.bgColor} onChange={e=>setTheme({...theme,bgColor:e.target.value})} className="w-8 h-8 rounded"/></Row>
              ) : (
                <Row label="å›¾ç‰‡">
                  <label className="text-xs btn px-2 py-1 rounded cursor-pointer">ä¸Šä¼ å›¾ç‰‡
                    <input type="file" accept="image/*" className="hidden" onChange={e=>{
                      const f=e.target.files&&e.target.files[0]; if(!f) return;
                      const r=new FileReader(); r.onload=()=>setTheme({...theme,bgImage:r.result}); r.readAsDataURL(f);
                    }}/>
                  </label>
                  {theme.bgImage && <button onClick={()=>setTheme({...theme,bgImage:''})} className="ml-2 text-xs px-2 py-1 rounded btn">æ¸…é™¤</button>}
                </Row>
              )}
            </div>
          )}
        </div>
      );
    }

    const Header=({title})=>(
      <div className="flex items-center justify-center">
        <div className="px-4 py-1.5 rounded-2xl bg-black/50 border border-white/10">{title}</div>
      </div>
    );
    const Row=({label,children})=>(<div className="flex items-center gap-3"><div className="w-24 shrink-0 text-xs opacity-90">{label}</div><div className="flex-1 flex items-center flex-wrap gap-2">{children}</div></div>);
    const TabButton=({active,onClick,children})=>(<button onClick={onClick} className={`px-3 py-1.5 rounded-lg border text-xs ${active?'bg-white/15 border-white/20':'bg-white/5 border-white/10 hover:bg-white/10'}`}>{children}</button>);

    ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
  </script>
</body>
</html>
